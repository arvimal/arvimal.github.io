
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet/less" type="text/css" href="https://arvimal.github.io/theme/stylesheet/style.less">
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.1/less.min.js" type="text/javascript"></script>

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="https://arvimal.github.io/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="https://arvimal.github.io/theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="https://arvimal.github.io/theme/pygments/monokai.min.css">


  <link rel="stylesheet" type="text/css" href="https://arvimal.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://arvimal.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://arvimal.github.io/theme/font-awesome/css/solid.css">


    <link href="https://arvimal.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="arvimal.github.io Atom">



  

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">

<meta name="author" content="Vimal A.R" />
<meta name="description" content="&#34;ceph&#34; tags: &#34;ceph&#34; &#34;monitors&#34; &#34;monmaptool&#34; The MON map is used by the monitors in a Ceph cluster, where they keep track of various attributes relevant to the working of the cluster. Similar to the CRUSH map, a monitor map can be pulled out of the cluster, inspected, changed, and injected …" />
<meta name="keywords" content="">


<meta property="og:site_name" content="arvimal.github.io"/>
<meta property="og:title" content="&#34;Monitor maps, how to edit them?&#34;"/>
<meta property="og:description" content="&#34;ceph&#34; tags: &#34;ceph&#34; &#34;monitors&#34; &#34;monmaptool&#34; The MON map is used by the monitors in a Ceph cluster, where they keep track of various attributes relevant to the working of the cluster. Similar to the CRUSH map, a monitor map can be pulled out of the cluster, inspected, changed, and injected …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://arvimal.github.io/monitor-maps-how-to-edit-them.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-09-01 00:00:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://arvimal.github.io/author/vimal-ar.html">
<meta property="article:section" content="misc"/>
<meta property="og:image" content="">

  <title>arvimal.github.io &ndash; &#34;Monitor maps, how to edit them?&#34;</title>

</head>
<body >
  <aside>
    <div>
      <a href="https://arvimal.github.io">
        <img src="https://arvimal.github.io/theme/img/profile.png" alt="" title="">
      </a>

      <h1>
        <a href="https://arvimal.github.io"></a>
      </h1>




      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/arvimal" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="/blog/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://arvimal.github.io">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://arvimal.github.io/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="monitor-maps-how-to-edit-them">"Monitor maps, how to edit them?"</h1>
    <p>
      Posted on September 01, 2015 in <a href="https://arvimal.github.io/category/misc.html">misc</a>

    </p>
  </header>


  <div>
    <ul>
<li>"ceph"
tags:</li>
<li>"ceph"</li>
<li>"monitors"</li>
<li>"monmaptool"</li>
</ul>
<hr>
<p>The <strong>MON map</strong> is used by the monitors in a Ceph cluster, where they keep track of various attributes relevant to the working of the cluster.</p>
<p>Similar to the <a href="http://ceph.com/papers/weil-crush-sc06.pdf">CRUSH</a> map, a monitor map can be pulled out of the cluster, inspected, changed, and injected back to the monitors, manually. A frequent use-case is when the IP address of a monitor changes and the monitors cannot agree on a quorum.</p>
<p>Monitors use the monitor map (<strong>monmap</strong>) to get the details of other monitors. So just changing the monitor address in '<strong>ceph.conf</strong>' and pushing the configuration to all the nodes won't help to propagate the changes.</p>
<p>In most cases, starting the monitor with a wrong monitor map would make the monitors commit suicide, since they would find conflicting information about themself in the mon map due to the IP address change.</p>
<p>There are two methods to fix this problem, the first being adding enough new monitors, let them form a quorum, and remove the faulty monitors. This doesn't need any explanation. The second and more crude way, is to edit the monitor map directly, set the new IP address, and upload the monmap back to the monitors.</p>
<p>This article discusses the second method, ie.. how to edit the monmap, and re-inject it back. This can be done using the '<strong>monmap</strong>' tool.</p>
<p>1. As the first step, login to one of the monitors, and get the monitor map:</p>
<blockquote>
<p><strong># ceph mon getmap -o /tmp/monitor_map.bin</strong></p>
</blockquote>
<p>2. Inspect what the monitor map contains:</p>
<blockquote>
<p><strong># monmaptool --print /tmp/monitor_map.bin</strong></p>
</blockquote>
<ul>
<li>An example from my cluster :</li>
</ul>
<blockquote>
<p><strong># monmaptool --print monmap</strong></p>
<p>monmaptool: monmap file monmap epoch 1 fsid d978794d-5835-4ac3-8fe3-3855b18b9572 last_changed 0.000000 created 0.000000 0: 192.168.122.73:6789/0 mon.node2</p>
</blockquote>
<p>3. Remove the node which has the wrong IP address, referring it's hostname</p>
<blockquote>
<p><strong># monmaptool --rm node2 /tmp/monitor_map.bin</strong></p>
</blockquote>
<p>4. Inspect the monitor map to see if the monitor is indeed removed.</p>
<blockquote>
<p><strong># monmaptool --print /tmp/monitor_map.bin</strong></p>
<p>monmaptool: monmap file monmap epoch 1 fsid d978794d-5835-4ac3-8fe3-3855b18b9572 last_changed 0.000000 created 0.000000</p>
</blockquote>
<p>5. Add a new monitor (or the existing monitor with it's new IP)</p>
<blockquote>
<p><strong># monmaptool --add node3  192.168.122.76:6789  /tmp/monitor_map.bin</strong></p>
<p>monmaptool: monmap file monmap monmaptool: writing epoch 1 to monmap (1 monitors)</p>
</blockquote>
<p>6. Check the monitor map to confirm the changes</p>
<blockquote>
<p><strong># monmaptool --print monmap</strong></p>
<p>monmaptool: monmap file monmap epoch 1 fsid d978794d-5835-4ac3-8fe3-3855b18b9572 last_changed 0.000000 created 0.000000 0: 192.168.122.76:6789/0 mon.node3</p>
</blockquote>
<p>7. Make sure the mon processes are not running on the monitor nodes</p>
<blockquote>
<p><strong># service ceph stop mon</strong></p>
</blockquote>
<p>8. Upload the changes</p>
<blockquote>
<p><strong># ceph-mon -i monitor_node --inject-monmap /tmp/mon_map.bin</strong></p>
</blockquote>
<p>9. Start the mon process on each monitor</p>
<blockquote>
<p><strong># service ceph start mon</strong></p>
</blockquote>
<p>10. Check if the cluster has taken in the changes.</p>
<blockquote>
<p><strong># ceph -s</strong></p>
</blockquote>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>





</article>

    <footer>
<p>
  &copy; 2021  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="https://arvimal.github.io/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " arvimal.github.io ",
  "url" : "https://arvimal.github.io",
  "image": "",
  "description": ""
}
</script>


</body>
</html>