<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Writing a minimalistic kernel module in Linux - Part 1 - The Child is Father of the Man</title><meta name="Description" content="The Child is Father of the Man"><meta property="og:title" content="Writing a minimalistic kernel module in Linux - Part 1" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://arvimal.github.io/writing-a-minimalistic-kernel-module/" /><meta property="og:image" content="https://arvimal.github.io/avatar.jpg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-07-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-08-12T12:22:07+02:00" /><meta property="og:site_name" content="The Child is Father of the Man" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://arvimal.github.io/avatar.jpg"/>

<meta name="twitter:title" content="Writing a minimalistic kernel module in Linux - Part 1"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://arvimal.github.io/writing-a-minimalistic-kernel-module/" /><link rel="prev" href="https://arvimal.github.io/recursion-algorithm-study/" /><link rel="next" href="https://arvimal.github.io/callables-in-python/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Writing a minimalistic kernel module in Linux - Part 1",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/arvimal.github.io\/writing-a-minimalistic-kernel-module\/"
        },"genre": "posts","keywords": "kernel, module","wordcount":  2226 ,
        "url": "https:\/\/arvimal.github.io\/writing-a-minimalistic-kernel-module\/","datePublished": "2017-07-27T00:00:00+00:00","dateModified": "2022-08-12T12:22:07+02:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Vimal A.R"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="auto" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="The Child is Father of the Man"></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="The Child is Father of the Man"></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Writing a minimalistic kernel module in Linux - Part 1</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/arvimal" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Vimal A.R</a></span>&nbsp;<span class="post-category">included in <a href="/categories/linux/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>linux</a>&nbsp;<a href="/categories/programming/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>programming</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="27-07-2017">27-07-2017</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;2226 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;11 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/vincentiu-solomon-ln5drpv_ImI.jpg"
        data-srcset="images/vincentiu-solomon-ln5drpv_ImI.jpg, images/vincentiu-solomon-ln5drpv_ImI.jpg 1.5x, images/vincentiu-solomon-ln5drpv_ImI.jpg 2x"
        data-sizes="auto"
        alt="images/vincentiu-solomon-ln5drpv_ImI.jpg"
        title="images/vincentiu-solomon-ln5drpv_ImI.jpg" /></div><div class="details toc" id="toc-static"  data-kept="true">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#structure">Structure</a></li>
    <li><a href="#depmod-and-related-commands">depmod, and related commands</a>
      <ul>
        <li><a href="#modulessymbols">modules.symbols</a></li>
        <li><a href="#modulesdep">modules.dep</a></li>
      </ul>
    </li>
    <li><a href="#creating-a-dummy-module">Creating a dummy module</a></li>
    <li><a href="#writing-a-simple-module">Writing a simple module</a></li>
    <li><a href="#writing-a-makefile">Writing a Makefile</a></li>
    <li><a href="#compiling-the-module-with-make">Compiling the module with <code>make</code></a></li>
    <li><a href="#loadingunloading-the-module">Loading/Unloading the module</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="introduction">Introduction</h2>
<p>_<strong>L</strong>_oadable Kernel Modules (LKM) are object code that can be loaded into memory, often used for supporting hardware or enable specific features.</p>
<p>Kernel modules enable the core kernel to be minimal and have features to be loaded as required.</p>
<p>A kernel module is a normal file usually suffixed with <code>.ko</code> denoting it&rsquo;s a kernel object file. It contains compiled code from one or more source files, gets linked to the kernel when loaded, and runs in kernel space. It can dynamically adds functionality to a running kernel, without requiring a reboot.</p>
<p>Linux kernel modules are written in C, and is compiled for a specific kernel version. This is the ideal practice since kernel data structures may change across versions, and using a module compiled for a specific version may break for another.</p>
<p>Since kernel modules can be loaded and unloaded at will, it is pretty easy to unload an older version and load a newer one. This helps immensely in testing out new features since it is easy to change the source code, re-compile, unload the older version, load the newer version, and test the functionality.</p>
<h2 id="structure">Structure</h2>
<p>Modules are expected to be under <code>/lib/modules/$(uname -r)/</code> within directories specified according to use case.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@centos7 3.10.0-514.26.2.el7.x86_64<span class="o">]</span> <span class="c1"># ls -l </span>
</span></span><span class="line"><span class="cl">total <span class="m">2940</span> 
</span></span><span class="line"><span class="cl">lrwxrwxrwx. <span class="m">1</span> root root <span class="m">43</span> Jul <span class="m">8</span> 05:10 build -&gt; /usr/src/kernels/3.10.0-514.26.2.el7.x86_64 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">6</span> Jul <span class="m">4</span> 11:17 extra 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">12</span> root root <span class="m">128</span> Jul <span class="m">8</span> 05:10 kernel 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">762886</span> Jul <span class="m">8</span> 05:11 modules.alias 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">735054</span> Jul <span class="m">8</span> 05:11 modules.alias.bin 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">1326</span> Jul <span class="m">4</span> 11:17 modules.block 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">6227</span> Jul <span class="m">4</span> 11:15 modules.builtin 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">8035</span> Jul <span class="m">8</span> 05:11 modules.builtin.bin 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">240071</span> Jul <span class="m">8</span> 05:11 modules.dep 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">343333</span> Jul <span class="m">8</span> 05:11 modules.dep.bin 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">361</span> Jul <span class="m">8</span> 05:11 modules.devname 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">132</span> Jul <span class="m">4</span> 11:17 modules.drm 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">110</span> Jul <span class="m">4</span> 11:17 modules.modesetting 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">1580</span> Jul <span class="m">4</span> 11:17 modules.networking 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">90643</span> Jul <span class="m">4</span> 11:15 modules.order 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">89</span> Jul <span class="m">8</span> 05:11 modules.softdep 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">350918</span> Jul <span class="m">8</span> 05:11 modules.symbols 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">432831</span> Jul <span class="m">8</span> 05:11 modules.symbols.bin 
</span></span><span class="line"><span class="cl">lrwxrwxrwx. <span class="m">1</span> root root <span class="m">5</span> Jul <span class="m">8</span> 05:10 <span class="nb">source</span> -&gt; build 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">6</span> Jul <span class="m">4</span> 11:17 updates 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">95</span> Jul <span class="m">8</span> 05:10 vdso 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">6</span> Jul <span class="m">4</span> 11:17 weak-updates
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see, there are several files that deals with the inter-dependencies of modules, which is used by <code>modprobe</code> to understand which modules to load before the one being actually requested to load.</p>
<p>For example:</p>
<ul>
<li><code>modules.block</code> lists the modules for block devices</li>
<li><code>modules.networking</code> lists the ones for network devices.</li>
<li><code>modules.builtin</code> lists the path of modules included in the kernel.</li>
<li><code>modules.devname</code> lists the ones that would be loaded automatically if a particular device is created.</li>
</ul>
<p>The kernel folder contains modules divided according to their use cases.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@centos7 3.10.0-514.26.2.el7.x86_64<span class="o">]</span><span class="c1"># ls -l kernel/ </span>
</span></span><span class="line"><span class="cl">total <span class="m">16</span> 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">3</span> root root <span class="m">17</span> Jul <span class="m">8</span> 05:10 arch 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">3</span> root root <span class="m">4096</span> Jul <span class="m">8</span> 05:10 crypto 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">67</span> root root <span class="m">4096</span> Jul <span class="m">8</span> 05:10 drivers 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">26</span> root root <span class="m">4096</span> Jul <span class="m">8</span> 05:10 fs 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">3</span> root root <span class="m">19</span> Jul <span class="m">8</span> 05:10 kernel 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">5</span> root root <span class="m">222</span> Jul <span class="m">8</span> 05:10 lib 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">32</span> Jul <span class="m">8</span> 05:10 mm 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">33</span> root root <span class="m">4096</span> Jul <span class="m">8</span> 05:10 net 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">11</span> root root <span class="m">156</span> Jul <span class="m">8</span> 05:10 sound 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">3</span> root root <span class="m">17</span> Jul <span class="m">8</span> 05:10 virt
</span></span></code></pre></td></tr></table>
</div>
</div><p>Each directory within kernel contains modules depending on the area they&rsquo;re used for.</p>
<p>For example, <code>kernel/fs/</code> contains filesystem drivers.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@centos7 3.10.0-514.26.2.el7.x86_64<span class="o">]</span><span class="c1"># ls -l kernel/fs </span>
</span></span><span class="line"><span class="cl">total <span class="m">48</span> 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">21853</span> Jul <span class="m">4</span> 11:51 binfmt_misc.ko 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">22</span> Jul <span class="m">8</span> 05:10 btrfs 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">27</span> Jul <span class="m">8</span> 05:10 cachefiles 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">21</span> Jul <span class="m">8</span> 05:10 ceph 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">21</span> Jul <span class="m">8</span> 05:10 cifs 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">23</span> Jul <span class="m">8</span> 05:10 cramfs 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">20</span> Jul <span class="m">8</span> 05:10 dlm 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">23</span> Jul <span class="m">8</span> 05:10 exofs 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">21</span> Jul <span class="m">8</span> 05:10 ext4
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">51</span> Jul <span class="m">8</span> 05:10 fat 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">24</span> Jul <span class="m">8</span> 05:10 fscache 
</span></span><span class="line"><span class="cl">rwxr-xr-x. <span class="m">2</span> root root <span class="m">36</span> Jul <span class="m">8</span> 05:10 fuse 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">21</span> Jul <span class="m">8</span> 05:10 gfs2 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">22</span> Jul <span class="m">8</span> 05:10 isofs 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">21</span> Jul <span class="m">8</span> 05:10 jbd2 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">22</span> Jul <span class="m">8</span> 05:10 lockd 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">19597</span> Jul <span class="m">4</span> 11:51 mbcache.ko 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">6</span> root root <span class="m">128</span> Jul <span class="m">8</span> 05:10 nfs 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">40</span> Jul <span class="m">8</span> 05:10 nfs_common 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">21</span> Jul <span class="m">8</span> 05:10 nfsd 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">4096</span> Jul <span class="m">8</span> 05:10 nls 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">24</span> Jul <span class="m">8</span> 05:10 overlayfs 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">24</span> Jul <span class="m">8</span> 05:10 pstore 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">25</span> Jul <span class="m">8</span> 05:10 squashfs 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">20</span> Jul <span class="m">8</span> 05:10 udf 
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root <span class="m">20</span> Jul <span class="m">8</span> 05:10 xfs
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="depmod-and-related-commands">depmod, and related commands</h2>
<p>Modules can export the features it carry, called <code>symbols</code> which can be used by other modules.</p>
<p>If module <code>A</code> depends on a symbol exported by module <code>B</code>, module <code>B</code> should be loaded first followed by module <code>A</code>.</p>
<p><code>depmod</code> creates a list of symbol dependencies each module has, so that <code>modprobe</code> can go ahead and load the modules serving the symbols, prior loading the actual module.</p>
<p><code>depmod</code> works by:</p>
<ol>
<li>Creating a list of symbols each module exports.</li>
<li>Creating a list of symbol dependencies each module has.</li>
<li>Dumping the list of symbols each module exports, to <code>lib/modules/$(uname -r)/modules.symbols.bin</code> and <code>/lib/modules/$(uname -r)/modules.symbols</code></li>
<li>Dumping the module dependency information to <code>/lib/modules/$(uname -r)/modules.dep.bin</code> and <code>/lib/modules/$(uname -r)/modules.dep</code>.</li>
<li>Creating <code>/lib/modules/$(uname -r)/modules.devnames</code> which contains the device file information (device type, major:minor number) that gets created at boot for this module to function properly.</li>
</ol>
<p><strong>NOTE</strong>:</p>
<ul>
<li><code>modprobe</code> refers <code>/lib/modules/$(uname -r)/modules.dep.bin</code> to understand the dependencies each module require.</li>
<li>A human-readable version of this file is maintained at <code>/lib/modules/$(uname -r)/modules.dep</code> but <code>modprobe</code> does not refer this.</li>
<li>The binary file <code>modules.symbols.bin</code> carry the symbols exported (if any) by each module, one symbol per line.</li>
<li>A human-readable version of the same is kept at <code>modules.symbols</code>.</li>
</ul>
<p>A sneak peek into <code>modules.symbols</code> and <code>modules.dep</code>:</p>
<h3 id="modulessymbols">modules.symbols</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@centos7 3.10.0-514.26.2.el7.x86_64<span class="o">]</span><span class="c1"># head modules.symbols </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Aliases for symbols, used by symbol_request(). </span>
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> symbol:cfg80211_report_obss_beacon cfg80211 
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> symbol:drm_dp_link_train_channel_eq_delay drm_kms_helper 
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> symbol:__twofish_setkey twofish_common 
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> symbol:mlx4_db_free mlx4_core 
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> symbol:nf_send_unreach nf_reject_ipv4 
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> symbol:sdhci_remove_host sdhci 
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> symbol:videobuf_dma_init_kernel videobuf_dma_sg 
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> symbol:ar9003_paprd_is_done ath9k_hw 
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> symbol:cxgbi_ep_disconnect libcxgbi
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="modulesdep">modules.dep</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@centos7 3.10.0-514.26.2.el7.x86_64<span class="o">]</span><span class="c1"># head modules.dep </span>
</span></span><span class="line"><span class="cl">kernel/arch/x86/kernel/cpu/mcheck/mce-inject.ko: 
</span></span><span class="line"><span class="cl">kernel/arch/x86/kernel/test_nx.ko: 
</span></span><span class="line"><span class="cl">kernel/arch/x86/kernel/iosf_mbi.ko: 
</span></span><span class="line"><span class="cl">kernel/arch/x86/crypto/ablk_helper.ko: 
</span></span><span class="line"><span class="cl">kernel/crypto/cryptd.ko 
</span></span><span class="line"><span class="cl">kernel/arch/x86/crypto/glue_helper.ko: 
</span></span><span class="line"><span class="cl">kernel/arch/x86/crypto/camellia-x86_64.ko: 
</span></span><span class="line"><span class="cl">kernel/crypto/xts.ko 
</span></span><span class="line"><span class="cl">kernel/crypto/lrw.ko 
</span></span><span class="line"><span class="cl">kernel/crypto/gf128mul.ko 
</span></span><span class="line"><span class="cl">kernel/arch/x86/crypto/glue_helper.ko 
</span></span><span class="line"><span class="cl">kernel/arch/x86/crypto/blowfish-x86_64.ko: 
</span></span><span class="line"><span class="cl">kernel/crypto/blowfish_common.ko 
</span></span><span class="line"><span class="cl">kernel/arch/x86/crypto/twofish-x86_64.ko: 
</span></span><span class="line"><span class="cl">kernel/crypto/twofish_common.ko 
</span></span><span class="line"><span class="cl">kernel/arch/x86/crypto/twofish-x86_64-3way.ko: 
</span></span><span class="line"><span class="cl">kernel/arch/x86/crypto/twofish-x86_64.ko 
</span></span><span class="line"><span class="cl">kernel/crypto/twofish_common.ko 
</span></span><span class="line"><span class="cl">kernel/crypto/xts.ko 
</span></span><span class="line"><span class="cl">kernel/crypto/lrw.ko 
</span></span><span class="line"><span class="cl">kernel/crypto/gf128mul.ko 
</span></span><span class="line"><span class="cl">kernel/arch/x86/crypto/glue_helper.ko 
</span></span><span class="line"><span class="cl">kernel/arch/x86/crypto/salsa20-x86_64.ko:
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>lsmod</code> is a parser that reads through <code>/proc/modules</code> and presents it in an easy-to-read format.</p>
<p>Note how <code>lsmod</code> parse throug the content of <code>/proc/modules</code> below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@centos7 3.10.0-514.26.2.el7.x86_64<span class="o">]</span><span class="c1"># head /proc/modules</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> <span class="m">12498</span> <span class="m">0</span> - Live 0xffffffffa0492000 <span class="o">(</span>POE<span class="o">)</span> 
</span></span><span class="line"><span class="cl">binfmt_misc <span class="m">17468</span> <span class="m">1</span> - Live 0xffffffffa048c000 
</span></span><span class="line"><span class="cl">uhid <span class="m">17369</span> <span class="m">0</span> - Live 0xffffffffa0486000 
</span></span><span class="line"><span class="cl">ipt_MASQUERADE <span class="m">12678</span> <span class="m">2</span> - Live 0xffffffffa0481000 
</span></span><span class="line"><span class="cl">nf_nat_masquerade_ipv4 <span class="m">13412</span> <span class="m">1</span> 
</span></span><span class="line"><span class="cl">ipt_MASQUERADE, Live 0xffffffffa0451000 
</span></span><span class="line"><span class="cl">xt_addrtype <span class="m">12676</span> <span class="m">2</span> - Live 0xffffffffa044c000 
</span></span><span class="line"><span class="cl">br_netfilter <span class="m">22209</span> <span class="m">0</span> - Live 0xffffffffa0468000 
</span></span><span class="line"><span class="cl">dm_thin_pool <span class="m">65565</span> <span class="m">1</span> - Live 0xffffffffa046f000 
</span></span><span class="line"><span class="cl">dm_persistent_data <span class="m">67216</span> <span class="m">1</span> 
</span></span><span class="line"><span class="cl">dm_thin_pool, Live 0xffffffffa0456000 
</span></span><span class="line"><span class="cl">dm_bio_prison <span class="m">15907</span> <span class="m">1</span> 
</span></span><span class="line"><span class="cl">dm_thin_pool, Live 0xffffffffa043f000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@centos7 3.10.0-514.26.2.el7.x86_64<span class="o">]</span><span class="c1"># lsmod | head </span>
</span></span><span class="line"><span class="cl">Module Size Used by 
</span></span><span class="line"><span class="cl"><span class="nb">test</span> <span class="m">12498</span> <span class="m">0</span> 
</span></span><span class="line"><span class="cl">binfmt_misc <span class="m">17468</span> <span class="m">1</span> 
</span></span><span class="line"><span class="cl">uhid <span class="m">17369</span> <span class="m">0</span> 
</span></span><span class="line"><span class="cl">ipt_MASQUERADE <span class="m">12678</span> <span class="m">2</span> 
</span></span><span class="line"><span class="cl">nf_nat_masquerade_ipv4 <span class="m">13412</span> <span class="m">1</span> 
</span></span><span class="line"><span class="cl">ipt_MASQUERADE xt_addrtype <span class="m">12676</span> <span class="m">2</span> 
</span></span><span class="line"><span class="cl">br_netfilter <span class="m">22209</span> <span class="m">0</span> 
</span></span><span class="line"><span class="cl">dm_thin_pool <span class="m">65565</span> <span class="m">1</span> 
</span></span><span class="line"><span class="cl">dm_persistent_data <span class="m">67216</span> <span class="m">1</span> dm_thin_pool
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>NOTE:</strong></p>
<ol>
<li>The first field lists the module name.</li>
<li>The second field lists the size of the module in memory.</li>
<li>The third field lists the number of times the module is in use. `0` means the module is not used despite it being loaded.</li>
<li>The fourth field lists the modules which uses this module as their dependency.</li>
</ol>
<h2 id="creating-a-dummy-module">Creating a dummy module</h2>
<p>The steps for creating a kernel module includes:</p>
<ol>
<li>Writing the module file.</li>
<li>Writing the <code>Makefile</code> for the module.</li>
<li>Compile the module file using <code>make</code> , which will refer the <code>Makefile</code> to build it.</li>
</ol>
<p>The module file and its corresponding <code>Makefile</code> are put in a separate directory so as to keep the kernel module directory clean.
Once the module code and the Makefile are ready, the <code>make</code> command is used to build the module, <code>$(PWD)</code> being the directory with the module code and Makefile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># make -C /lib/modules/$(uname -r)/build M=$PWD modules</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>make</code> command above does the following:</p>
<ol>
<li>Change to the path mentioned after <code>-C</code>, ie.. to the location where the kernel Makefile is present. (<code>/lib/modules/$(uname -r)/build/</code>)</li>
<li>Use the kernel Makefile&rsquo;s macro <code>M</code> which denotes the location from which the code should be compiled, ie.. in this case, the PWD where the module code/Makefile is present.</li>
<li>Use the target <code>modules</code> which tells <code>make</code> to build the module.</li>
</ol>
<p><code>make</code> is trying to build a module in the current working directory, using the kernel Makefile at <code>/lib/modules/$(uname -r)/build/Makefile</code></p>
<p>If we have a module file named <code>test.c</code> and its corresponding Makefile in <code>$(PWD)</code>, the <code>make</code> command would follow the steps below:</p>
<ol>
<li><code>make</code> calls the <code>modules</code> target and refers to the kernel <code>Makefile</code>.</li>
<li>The kernel Makefile looks for the module Makefile in $PWD.</li>
<li>The kernel Makefile read the module&rsquo;s Makefile and gets a list of the objects assigned to the macro <code>obj-m</code>.</li>
<li>The <code>make</code> command builds modules for each object assigned to the macro <code>obj-m</code>.</li>
</ol>
<h2 id="writing-a-simple-module">Writing a simple module</h2>
<p>The following is a very simple module, which prints a message while loading, and another one while unloading.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">test_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;Loading the test module!</span><span class="se">\\</span><span class="s">n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">unload_test</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;Unloading the test module!</span><span class="se">\\</span><span class="s">n&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">module_init</span><span class="p">(</span><span class="n">test_module</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="nf">module_exit</span><span class="p">(</span><span class="n">unload_test</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This has two functions, <code>test_module()</code> and <code>unload_test()</code> which simply prints a text banner upon loading and unloading respectively.</p>
<p><code>module_init()</code> is used to load the module, and can call whatever functions that needs to initialize the module.
We load our <code>test_module()</code> function into <code>module_init()</code> so that it gets initialized when the module is loaded.</p>
<p><code>module_exit()</code> is called whenever the module has to be unloaded, and it can take in whatever functions are required to do a proper cleanup (if required) prior the module being unloaded.
We load our <code>unload_test()</code> function in <code>module_exit()</code>.</p>
<h2 id="writing-a-makefile">Writing a Makefile</h2>
<p>Since the kernel Makefile will look in for the <code>obj-m</code> macro in the module Makefile with the object filename as its argument, add the following in the Makefile:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">obj-m :<span class="o">=</span> test.o
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>make</code> will create an object file <code>test.o</code> from <code>test.c</code>, and then create a kernel object file <code>test.ko</code>.</p>
<h2 id="compiling-the-module-with-make">Compiling the module with <code>make</code></h2>
<p>Let&rsquo;s compile the module</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@centos7 test<span class="o">]</span><span class="c1"># pwd </span>
</span></span><span class="line"><span class="cl">/lib/modules/3.10.0-514.26.2.el7.x86_64/test 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@centos7 test<span class="o">]</span><span class="c1"># ls </span>
</span></span><span class="line"><span class="cl">Makefile test.c 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@centos7 test<span class="o">]</span><span class="c1"># make -C /lib/modules/$(uname -r)/build M=$PWD modules </span>
</span></span><span class="line"><span class="cl">make: Entering directory <span class="sb">`</span>/usr/src/kernels/3.10.0-514.26.2.el7.x86_64<span class="s1">&#39; 
</span></span></span><span class="line"><span class="cl"><span class="s1">CC \[M\] /lib/modules/3.10.0-514.26.2.el7.x86_64/test/test.o Building modules, stage 2. MODPOST 1 modules 
</span></span></span><span class="line"><span class="cl"><span class="s1">CC /lib/modules/3.10.0-514.26.2.el7.x86_64/test/test.mod.o 
</span></span></span><span class="line"><span class="cl"><span class="s1">LD \[M\] /lib/modules/3.10.0-514.26.2.el7.x86_64/test/test.ko 
</span></span></span><span class="line"><span class="cl"><span class="s1">make: Leaving directory \`/usr/src/kernels/3.10.0-514.26.2.el7.x86_64&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Listing the contents show lot of new files, including the module code, the Makefile, the object file <code>test.o</code> created from <code>test.c</code>, the kernel object file <code>test.ko</code>.</p>
<p><code>test.mod.c</code> contains code which should be the one ultimately being built to <code>test.ko</code>, but that should be for another post since much more is yet to be read/learned on what&rsquo;s happening there.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@centos7 test<span class="o">]</span><span class="c1"># ls -l </span>
</span></span><span class="line"><span class="cl">total <span class="m">292</span> 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">16</span> Jul <span class="m">27</span> 11:52 Makefile 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">60</span> Jul <span class="m">27</span> 11:57 modules.order 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> Jul <span class="m">27</span> 11:57 Module.symvers 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">281</span> Jul <span class="m">27</span> 11:53 test.c 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">137768</span> Jul <span class="m">27</span> 11:57 test.ko 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">787</span> Jul <span class="m">27</span> 11:57 test.mod.c 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">52912</span> Jul <span class="m">27</span> 11:57 test.mod.o 
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">87776</span> Jul <span class="m">27</span> 11:57 test.o
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="loadingunloading-the-module">Loading/Unloading the module</h2>
<p>Loading and unloading the module should print the messages passed via <code>printk</code> in <code>dmesg</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@centos7 test<span class="o">]</span><span class="c1"># insmod ./test.ko </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@centos7 test<span class="o">]</span><span class="c1"># lsmod | grep test </span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> <span class="m">12498</span> <span class="m">0</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@centos7 test<span class="o">]</span><span class="c1"># rmmod test</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Checking <code>dmesg</code> shows the informational messages in the module code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@centos7 test<span class="o">]</span><span class="c1"># dmesg | tail </span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>35889.187282<span class="o">]</span> test: loading out-of-tree module taints kernel. 
</span></span><span class="line"><span class="cl"><span class="o">[</span>35889.187288<span class="o">]</span> test: module license <span class="s1">&#39;unspecified&#39;</span> taints kernel. 
</span></span><span class="line"><span class="cl"><span class="o">[</span>35889.187290<span class="o">]</span> Disabling lock debugging due to kernel taint 
</span></span><span class="line"><span class="cl"><span class="o">[</span>35889.187338<span class="o">]</span> test: module verification failed: signature and/or required key missing - tainting kernel 
</span></span><span class="line"><span class="cl"><span class="o">[</span>35889.187548<span class="o">]</span> Loading the <span class="nb">test</span> module! 
</span></span><span class="line"><span class="cl"><span class="o">[</span>35899.216954<span class="o">]</span> Unloading the <span class="nb">test</span> module!
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note the messages about the module <code>test</code> tainting the kernel.</p>
<p>Read more on how a module can taint the kernel, at <a href="https://www.kernel.org/doc/html/latest/admin-guide/tainted-kernels.html" target="_blank" rel="noopener noreffer ">https://www.kernel.org/doc/html/latest/admin-guide/tainted-kernels.html.</a></p>
<p>More on customizing the <code>Makefile</code> in another post.</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 12-08-2022</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/writing-a-minimalistic-kernel-module/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://arvimal.github.io/writing-a-minimalistic-kernel-module/" data-title="Writing a minimalistic kernel module in Linux - Part 1" data-hashtags="kernel,module"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://arvimal.github.io/writing-a-minimalistic-kernel-module/" data-hashtag="kernel"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://arvimal.github.io/writing-a-minimalistic-kernel-module/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://arvimal.github.io/writing-a-minimalistic-kernel-module/" data-title="Writing a minimalistic kernel module in Linux - Part 1"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://arvimal.github.io/writing-a-minimalistic-kernel-module/" data-title="Writing a minimalistic kernel module in Linux - Part 1"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://arvimal.github.io/writing-a-minimalistic-kernel-module/" data-title="Writing a minimalistic kernel module in Linux - Part 1" data-image="images/vincentiu-solomon-ln5drpv_ImI.jpg"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/kernel/">kernel</a>,&nbsp;<a href="/tags/module/">module</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/recursion-algorithm-study/" class="prev" rel="prev" title="Recursion - Algorithm Study"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Recursion - Algorithm Study</a>
            <a href="/callables-in-python/" class="next" rel="next" title="Callables in Python">Callables in Python<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.120.4">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/arvimal" target="_blank">Vimal A.R</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
