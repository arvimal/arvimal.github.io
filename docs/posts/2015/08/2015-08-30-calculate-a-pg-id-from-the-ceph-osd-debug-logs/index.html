<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Calculate a PG id from the hex values in Ceph OSD debug logs - The Child is Father of the Man</title><meta name="Description" content=""><meta property="og:title" content="Calculate a PG id from the hex values in Ceph OSD debug logs" />
<meta property="og:description" content="Recently, I had an incident where the OSDs were crashing at the time of startup. Obviously, the next step was to enable debug logs for the OSDs and understand where they were crashing.
Enabled OSD debug logs dynamically by injecting it with:
 # ceph tell osd.* injectargs &ndash;debug-osd 20 &ndash;debug-ms 1
 NOTE: This command can be run from the MON nodes.
Once this was done, the OSDs were started manually (since it were crashing and not running) and watched out for the next crash." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://arvimal.github.io/posts/2015/08/2015-08-30-calculate-a-pg-id-from-the-ceph-osd-debug-logs/" />
<meta property="article:published_time" content="2015-08-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-08-30T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Calculate a PG id from the hex values in Ceph OSD debug logs"/>
<meta name="twitter:description" content="Recently, I had an incident where the OSDs were crashing at the time of startup. Obviously, the next step was to enable debug logs for the OSDs and understand where they were crashing.
Enabled OSD debug logs dynamically by injecting it with:
 # ceph tell osd.* injectargs &ndash;debug-osd 20 &ndash;debug-ms 1
 NOTE: This command can be run from the MON nodes.
Once this was done, the OSDs were started manually (since it were crashing and not running) and watched out for the next crash."/>
<meta name="application-name" content="The Child is Father of the Man">
<meta name="apple-mobile-web-app-title" content="The Child is Father of the Man"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://arvimal.github.io/posts/2015/08/2015-08-30-calculate-a-pg-id-from-the-ceph-osd-debug-logs/" /><link rel="prev" href="https://arvimal.github.io/posts/2015/08/2015-08-17-how-can-we-map-a-pg-to-a-pool/" /><link rel="next" href="https://arvimal.github.io/posts/2015/09/2015-09-01-how-to-extract-view-change-and-inject-a-monitor-map-in-a-ceph-cluster/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Calculate a PG id from the hex values in Ceph OSD debug logs",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/arvimal.github.io\/posts\/2015\/08\/2015-08-30-calculate-a-pg-id-from-the-ceph-osd-debug-logs\/"
        },"genre": "posts","keywords": "ceph, pg, python","wordcount":  551 ,
        "url": "https:\/\/arvimal.github.io\/posts\/2015\/08\/2015-08-30-calculate-a-pg-id-from-the-ceph-osd-debug-logs\/","datePublished": "2015-08-30T00:00:00+00:00","dateModified": "2015-08-30T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Author"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="The Child is Father of the Man">The Child is Father of the Man</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="The Child is Father of the Man">The Child is Father of the Man</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Calculate a PG id from the hex values in Ceph OSD debug logs</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Author</a></span>&nbsp;<span class="post-category">included in <a href="/categories/ceph/"><i class="far fa-folder fa-fw"></i>ceph</a>&nbsp;<a href="/categories/programming/"><i class="far fa-folder fa-fw"></i>programming</a>&nbsp;<a href="/categories/python/"><i class="far fa-folder fa-fw"></i>python</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2015-08-30">2015-08-30</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;551 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;3 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents"></nav></div>
            </div><div class="content" id="content"><p>Recently, I had an incident where the OSDs were crashing at the time of startup. Obviously, the next step was to enable debug logs for the OSDs and understand where they were crashing.</p>
<p>Enabled OSD debug logs dynamically by injecting it with:</p>
<blockquote>
<p># ceph tell osd.* injectargs &ndash;debug-osd 20 &ndash;debug-ms 1</p>
</blockquote>
<p><em>NOTE: This command can be run from the MON nodes.</em></p>
<p>Once this was done, the OSDs were started manually (since it were crashing and not running) and watched out for the next crash. It crashed with the following logs :</p>
<blockquote>
<p>*read_log 107487'1 (0'0) modify f6b07b93/rbd_data.hash/head//12 by client.version date, time *osd/PGLog.cc: In function &lsquo;static bool PGLog::read_log(ObjectStore*, coll_t, hobject_t, const pg_info_t&amp;, std::mapeversion_t, hobject_t&amp;, PGLog::IndexedLog&amp;, pg_missing_t&amp;, std::ostringstream&amp;, std::setstd::basic_stringchar *)&rsquo; thread thread time date, time *osd/PGLog.cc: 809: FAILED assert(last_e.version.version e.version.version)ceph version version-details</p>
<p>1: (PGLog::read_log(ObjectStore*, coll_t, hobject_t, pg_info_t const&amp;, std::mapeversion_t, hobject_t, std::lesseversion_t, std::allocatorstd::paireversion_t const,hobject_t , PGLog::IndexedLog&amp;, pg_missing_t&amp;, std::basic_ostringstreamchar, std::char_traitschar, std::allocatorchar, std::setstd::string, std::lessstd:string, std::allocatorstd::string *)+0x13ee) [0x6efcae] 2: (PG::read_state(ObjectStore*, ceph::buffer::list&amp;)+0x315) [0x7692f5] 3: (OSD::load_pgs()+0xfff) [0x639f8f] 4: (OSD::init()+0x7bd) [0x63c10d] 5: (main()+0x2613) [0x5ecd43] 6: (__libc_start_main()+0xf5) [0x7fdc338f9af5] 7: /usr/bin/ceph-osd() [0x5f0f69]</p>
</blockquote>
<p>The above is a log snippet at which the OSD process was crashing. The ceph-osd process was reading through the log areas of each PG in the OSD, and once it reached the problematic PG it crashed due to failing an assert condition.</p>
<p>Checking the source at &lsquo;osd/PGLog.cc&rsquo;, we see that this error is logged from &lsquo;PGLog::read_log&rsquo;.</p>
<blockquote>
<p>void PGLog::read_log(ObjectStore *store, coll_t pg_coll, coll_t log_coll, ghobject_t log_oid, const pg_info_tinfo, mapeversion_t, hobject_tdivergent_priors, IndexedLoglog, pg_missing_tmissing, ostringstreamoss, setstring *log_keys_debug) { &hellip; if (!log.log.empty()) { pg_log_entry_t last_e(log.log.back()); assert(last_e.version.version e.version.version);    == The assert condition at which read_log is failing for a particular PG assert(last_e.version.epoch = e.version.epoch);</p>
</blockquote>
<p>In order to make the OSD start, we needed to move this PG to a different location using the &lsquo;ceph_objectstore_tool&rsquo; so that the ceph-osd can bypass the problematic PG. To understand the PG where it was crashing, we had to do some calculations based on the logs.</p>
<p>The &lsquo;read_log&rsquo; line in the debug logs contain a hex value after the string &ldquo;modify&rdquo; and that is the hash of the PG number. The last number in that series is the pool id (12 in our case). The following python code will help to calculate the PG id based on the arguments passed to it.</p>
<p>This program accepts three arguments, the first being the hex value we talked about, the second being the pg_num of the pool, and the third one being the pool id.</p>
<p>[code language=&ldquo;python&rdquo;]</p>
<p>#!/usr/bin/env python # Calculate the PG ID from the object hash # <a href="mailto:vimal@redhat.com">vimal@redhat.com</a> import sys</p>
<p>def pg_id_calc(*args): if any([len(args) == 0, len(args) &gt; 3, len(args) &lt; 3]): help() else: hash_hex = args[0] pg_num = int(args[1]) pool_id = int(args[2]) hash_dec = int(hash_hex, 16) id_dec = hash_dec % pg_num id = hex(id_dec) pg_id = str(pool_id) + &ldquo;.&rdquo; + str(id)[2:] print(&quot;\nThe PG ID is %s\n&quot; % pg_id)</p>
<p>def help(): print(&ldquo;Usage:&quot;) print(&ldquo;This script expects the hash (in Hex), pg_num of the pool, and the pool id as arguments, in order&rdquo;) print(&quot;\nExample:&quot;) print(&rdquo;./pg_id_calc.py 0x8e2fe5d7 2048 12&quot;) sys.exit()</p>
<p>if __name__ == &lsquo;__main__': pg_id_calc(*sys.argv[1:])</p>
<p>[/code]</p>
<p>An example of the program in action:</p>
<blockquote>
<p># python pg_id_calc.py 0xf6b07b93 2048 12 The PG ID is 12.393</p>
</blockquote>
<p>Once we get the PG ID, we can proceed using &lsquo;ceph_objectstore_tool&rsquo; to move the PG to a different location altogether. More on how to use &lsquo;ceph_objectstore_tool&rsquo; in an upcoming journal.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2015-08-30</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/ceph/">ceph</a>,&nbsp;<a href="/tags/pg/">pg</a>,&nbsp;<a href="/tags/python/">python</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2015/08/2015-08-17-how-can-we-map-a-pg-to-a-pool/" class="prev" rel="prev" title="Mapping Placement Groups and Pools"><i class="fas fa-angle-left fa-fw"></i>Mapping Placement Groups and Pools</a>
            <a href="/posts/2015/09/2015-09-01-how-to-extract-view-change-and-inject-a-monitor-map-in-a-ceph-cluster/" class="next" rel="next" title="Monitor maps, how to edit them?">Monitor maps, how to edit them?<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.80.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
