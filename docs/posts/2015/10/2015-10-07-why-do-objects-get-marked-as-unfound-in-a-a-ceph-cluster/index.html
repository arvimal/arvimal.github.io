<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Ceph and unfound objects - The Child is Father of the Man</title><meta name="Description" content=""><meta property="og:title" content="Ceph and unfound objects" />
<meta property="og:description" content="In certain cases, a Ceph cluster may move away from an HEALTHY state due to “unfound” objects.
A “ceph -s” should show if you have any unfound objects. So, what are unfound objects? How does an object become “unfound”? This article tries to explain why/how “unfound” objects come into existence.
Let’s look into the life cycle of a write to a pool.
 The client contacts a Ceph monitor and fetches the CRUSH map, which includes:  MON map OSD map PG map CRUSH map MDS map    Once the client has the maps, the Ceph client-side algorithm breaks the data being written into objects (the object size depends on the client side configuration)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://arvimal.github.io/posts/2015/10/2015-10-07-why-do-objects-get-marked-as-unfound-in-a-a-ceph-cluster/" />
<meta property="article:published_time" content="2015-10-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-10-07T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ceph and unfound objects"/>
<meta name="twitter:description" content="In certain cases, a Ceph cluster may move away from an HEALTHY state due to “unfound” objects.
A “ceph -s” should show if you have any unfound objects. So, what are unfound objects? How does an object become “unfound”? This article tries to explain why/how “unfound” objects come into existence.
Let’s look into the life cycle of a write to a pool.
 The client contacts a Ceph monitor and fetches the CRUSH map, which includes:  MON map OSD map PG map CRUSH map MDS map    Once the client has the maps, the Ceph client-side algorithm breaks the data being written into objects (the object size depends on the client side configuration)."/>
<meta name="application-name" content="The Child is Father of the Man">
<meta name="apple-mobile-web-app-title" content="The Child is Father of the Man"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://arvimal.github.io/posts/2015/10/2015-10-07-why-do-objects-get-marked-as-unfound-in-a-a-ceph-cluster/" /><link rel="prev" href="https://arvimal.github.io/posts/2015/10/2015-10-07-objects-remain-in-a-ceph-pool-used-for-rbd-even-if-the-files-are-deleted-from-the-mount-point/" /><link rel="next" href="https://arvimal.github.io/posts/2015/10/2015-10-12-range-and-enumerate-2/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Ceph and unfound objects",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/arvimal.github.io\/posts\/2015\/10\/2015-10-07-why-do-objects-get-marked-as-unfound-in-a-a-ceph-cluster\/"
        },"genre": "posts","wordcount":  747 ,
        "url": "https:\/\/arvimal.github.io\/posts\/2015\/10\/2015-10-07-why-do-objects-get-marked-as-unfound-in-a-a-ceph-cluster\/","datePublished": "2015-10-07T00:00:00+00:00","dateModified": "2015-10-07T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Author"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="The Child is Father of the Man">The Child is Father of the Man</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="The Child is Father of the Man">The Child is Father of the Man</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Ceph and unfound objects</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Author</a></span>&nbsp;<span class="post-category">included in <a href="/categories/ceph/"><i class="far fa-folder fa-fw"></i>ceph</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2015-10-07">2015-10-07</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;747 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents"></nav></div>
            </div><div class="content" id="content"><p>In certain cases, a Ceph cluster may move away from an HEALTHY state due to “<strong>unfound</strong>” objects.</p>
<p>A “<strong><em>ceph -s</em></strong>” should show if you have any unfound objects. So, what are unfound objects? How does an object become “<strong>unfound</strong>”? This article tries to explain why/how “<strong>unfound</strong>” objects come into existence.</p>
<p>Let’s look into the life cycle of a write to a pool.</p>
<ul>
<li>The client contacts a Ceph monitor and fetches the CRUSH map, which includes:
<ul>
<li>MON map</li>
<li>OSD map</li>
<li>PG map</li>
<li>CRUSH map</li>
<li>MDS map</li>
</ul>
</li>
</ul>
<p>Once the client has the maps, the Ceph client-side algorithm breaks the data being written into objects (the object size depends on the client side configuration). Clients such as RBD and RGW uses a 4MB object size, but RADOS doesn’t actually have such a limitation.</p>
<p>Each pool has a set of <strong>Placement Groups</strong> (<strong>PG</strong>) assigned to it at the time of creation, and the client always writes to a pool. Since the client has the maps which talks about the entire cluster, it knows the placement groups within the pool which it is writing to, and the OSDs assigned for each placement group. The client talks to the OSDs directly without going over any other path, such as a monitor.</p>
<p>The PG map will have the <strong>ACTING</strong> and <strong>UP</strong> OSD sets for each PG. To understand the ACTING set and UP set for the PGs, as well as a plethora of other information, use :</p>
<p>[code language=&ldquo;bash&rdquo;] # ceph pg dump [/code]</p>
<p>The ACTING set is the current active set of OSDs that stores the replica sets for that particular PG. The UP set is the set of OSDs that are currently up and running. Usually, the ACTING set and UP set are the same. When an OSD in the ACTING set is not reachable, other OSDs wait for 5 minutes (which is configurable) for it to come back online (this is checked with a hearbeat).</p>
<p>The said OSD is removed out of the UP set when it is not accessible. If it doesn’t come back online within the configured period, the said OSD is marked out of the ACTING set, as well as the UP set. When it comes back, it is added back to the ACTING/UP set and a peering happens where the data is synced back.</p>
<p>Let’s discuss the scenario where an “unfound” object came come into existence. Imagine a pool with a two replica configuration. A write that goes into the pool is split into objects and stored in the OSDs which are in the ACTIVE set of a PG.</p>
<ul>
<li>One OSD in the ACTING set goes down.</li>
<li>The write is done on the second OSD which is UP and ACTING.</li>
<li>The first OSD which went down, came back up.</li>
<li>The peering process started between the first OSD (that came back), and the second OSD (that serviced the write).
<ul>
<li>Peering refers to the process of arriving at an understanding on the object states between the OSDs in an ACTING set, and sync up the metadata/data between them.</li>
</ul>
</li>
<li>Both the OSDs reach an understanding on which objects needs to be synced.</li>
<li>The second OSD that had the objects ready to be synced, went down before the sync process starts or is in midway.</li>
</ul>
<p>In this situation, the first OSD knows about the objects that was written to the second OSD, but cannot probe it. The first OSD will try to probe possible locations for copies, provided there are more replicas. If the OSD is able to find other locations, the data will be synced up.</p>
<p>But in case there are no other copies, and the OSD with the only copy is not coming up anytime soon (perhaps a disk crash, file system corruption etc..) the only way is to either mark the object as “lost”, or revert it back to the previous version. Reverting to a previous version may not be possible for a new object, and in such cases the only way would be to mark it as “lost” or copy from a backup.</p>
<p>1. For a new object without a previous version:</p>
<p>[code language=&ldquo;bash&rdquo;] # ceph pg {pg.num} mark_unfound_lost delete [/code]</p>
<p>2. For an object which is likely to have a previous version:</p>
<p>[code language=&ldquo;bash&rdquo;] # ceph pg {pg.num} mark_unfound_lost revert [/code]</p>
<p><strong>NOTE:</strong> The upstream Ceph documentation has an excellent write-up about “unfound” objects <a href="http://docs.ceph.com/docs/master/rados/troubleshooting/troubleshooting-pg/#unfound-objects" target="_blank" rel="noopener noreffer">here</a>.</p>
<p>I suggest reading the documentation prior taking any sort of action in a case where you see “unfound” objects in your cluster.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2015-10-07</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2015/10/2015-10-07-objects-remain-in-a-ceph-pool-used-for-rbd-even-if-the-files-are-deleted-from-the-mount-point/" class="prev" rel="prev" title="Ceph Rados Block Device (RBD) and TRIM"><i class="fas fa-angle-left fa-fw"></i>Ceph Rados Block Device (RBD) and TRIM</a>
            <a href="/posts/2015/10/2015-10-12-range-and-enumerate-2/" class="next" rel="next" title="range() and enumerate()">range() and enumerate()<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.80.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
