<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>lsusb and chroot in anaconda.. Is usbfs mounted in anaconda %post installation ? - The Child is Father of the Man</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="The Child is Father of the Man" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">The Child is Father of the Man</div>
					<div class="logo__tagline">Technical notes... almost</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">Home Page</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about">
				
				<span class="menu__text">About me</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/resume">
				
				<span class="menu__text">Resume</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">lsusb and chroot in anaconda.. Is usbfs mounted in anaconda %post installation ?</h1>
			
		</header><div class="content post__content clearfix">
			<p>**<em>T</em>**he binary &lsquo;/sbin/lsusb&rsquo; in a chroot-ed environment have problems running properly. I have not checked this in a manually created chroot environment or using tools like &lsquo;mock&rsquo;.</p>
<p>The scenario is as following :</p>
<p>We were trying to check the output of &lsquo;lsusb&rsquo; in the %post section of a kickstart installation. I had specified &lsquo;noreboot&rsquo; in the kickstart file so the machine will wait for the user to manually reboot the machine. This helps to check the logs and the situation of the machine just after the installation finishes.</p>
<p>After the installation and prior to the reboot, i checked in the second available terminal (Alt + F2) created by anaconda and was astonished to see that the command &lsquo;lsusb&rsquo; does not give us the required output but an error that &lsquo;/usr/share/hwdata/usb.ids&rsquo; is not accessible or found.</p>
<p>By default, i think only the &lsquo;installation&rsquo; ie.. the %post section starts in a &lsquo;chroot&rsquo; mode and the terminal available is not chroot-ed. So we will have to use &lsquo;/mnt/sysimage/sbin/lsusb&rsquo;. This didn&rsquo;t work as expected since the &lsquo;lsusb&rsquo; binary needs to check the file &lsquo;/usr/share/hwdata/usb.ids&rsquo; and won&rsquo;t be able to find it.</p>
<p>So I did a chroot from the second terminal and did an /sbin/lsusb, since /sbin in not in the &lsquo;PATH&rsquo; by default. That too, didn&rsquo;t work out. But this time it didn&rsquo;t even complain anything. Just nothing at all, no output. Last time, at-least it complained it could not find something. So how do we go forward now ??? Here comes &lsquo;strace&rsquo; to the rescue !!!</p>
<p>strace is of-course a really nice tool to know what system calls are made and lots of internal stuff a binary will do while being executed. But &lsquo;strace&rsquo; is not installed by default on a RHEL5 machine, which is the case here. As most of you would know, anaconda creates a virtual file system which consists of most of the folders found under a linux main /. The location where the OS is installed is mounted under /mnt/sysimage.</p>
<p>Since we already have an ISO from where we have booted the machine from (DVD/CD), we are free to mount it on the filesystem, which is what we did. :</p>
<pre><code>  # mkdir /mnt/source 
  # mount -t iso9660 /dev/hdc /mnt/source 
  # cd /mnt/source/Server/ 
</code></pre><p>In case you want to know how the DVD/CD drive is detected, all you need to do is execute &lsquo;dmesg&rsquo; in the available terminal. ie.. after pressing &lsquo;Alt + Ctrl + F2&rsquo;.</p>
<p>So we went forward and mounted the DVD to /mnt/source and changed the directory to /mnt/source/Server where all the rpm packages reside. Installed the package &lsquo;strace&rsquo; using an &lsquo;rpm -ivh&rsquo;. Please note that we need to use &lsquo;&ndash;root /mnt/sysimage&rsquo; as an option since we are installing the package to our newly installed file system which is at /mnt/sysimage. If this is not used, the installer will try to install the package to the virtual environment created in the memory.</p>
<pre><code># cd /mnt/source/Server 
# rpm -ivh strace -fxvttT rpm --root /mnt/sysimage 
# cd 
# chroot /mnt/sysimage
</code></pre><p>This will make /mnt/sysimage as the working root, ie.. where our installation was done. OK.. now for the &lsquo;strace&rsquo; stuff.</p>
<pre><code># strace -fxvto strace.log -s 1024 /sbin/lsusb
</code></pre><p>The strace output will be saved to &lsquo;strace.log&rsquo; which we can open up in a text editor of our choice. Opening it in &lsquo;vi&rsquo;, shows a lot of stuff such as the command run, the default language, location of libraries loaded, the environment variables etc.. In this case we would only need to be interested in the last parts, ie.. to know where the binary failed :</p>
<pre><code>15:16:17 open(&quot;/dev/bus/usb&quot;, O\_RDONLY|O\_NONBLOCK|O\_DIRECTORY) = -1 ENOENT (No such file or directory) = 03067 
15:16:17 open(&quot;/proc/bus/usb&quot;, O\_RDONLY|O\_NONBLOCK|O\_DIRECTORY) = 33067 
15:16:17 fstat(3, {st\_dev=makedev(0, 3), st\_ino=4026532146, st\_mode=S\_IFDIR|0555, st\_nlink=2, st\_uid=0, st\_gid=0, st\_blksize=4096, st\_blocks=0, st\_size=0, st\_atime=2009/09/25-15:16:17, st\_mtime=2009/09/25-15:16:17, st\_ctime=2009/09/25-15:16:17}) = 03067 15:16:17 fcntl(3, F\_SETFD, FD\_CLOEXEC) = 03067 15:16:17 getdents(3, {{d\_ino=4026532146, d\_off=1, d\_reclen=24, d\_name=&quot;.&quot;} {d\_ino=4026531879, d\_off=2, d\_reclen=24, d\_name=&quot;..&quot;}}, 4096) = 483067 
15:16:17 getdents(3, {}, 4096) = 03067 15:16:17 close(3) = 03067 15:16:17 exit\_group(1) = ? 
</code></pre><p>The above trace output shows how the &lsquo;lsusb&rsquo; binary proceeded at its last time and where it failed. We can see that it went to open &lsquo;/dev/bus/usb&rsquo;, only to find that the said location does not exist. We can understand that it is a directory from the call</p>
<pre><code>open(&quot;/dev/bus/usb&quot;, O\_RDONLY|O\_NONBLOCK|O\_DIRECTORY)
</code></pre><p>Ok,, fine.. so what does it do next ?</p>
<p>As the next step, it tries to open &lsquo;/proc/bus/usb&rsquo; and it is present, which we know since there are no &lsquo;No such file or directory&rsquo; errors. Going further, the binary goes on to do a &lsquo;stat&rsquo; on &lsquo;/proc/bus/usb&rsquo;. After doing an &lsquo;fstat&rsquo;, it goes to check the file descriptor using &lsquo;fcntl&rsquo; and further goes to list the directory contents using &lsquo;getdents&rsquo;.</p>
<p>This is where we find the interesting output :</p>
<pre><code>getdents(3, {{d\_ino=4026532146, d\_off=1, d\_reclen=24, d\_name=&quot;.&quot;} {d\_ino=4026531879, d\_off=2, d\_reclen=24, d\_name=&quot;..&quot;}}, 4096) = 48
</code></pre><p>As you can see in the above trace, it returns &lsquo;.&rsquo; and &lsquo;..&rsquo;, which means there are nothing in /proc/bus/usb. So what we do understand is &lsquo;lsusb&rsquo; refers /dev/bus/usb and /proc/bus/usb for its outputs.. If it was not able to find anything, strace would have given us an error which obviously would have made life much easier.</p>
<p>And that&rsquo;s how &lsquo;/sbin/lsusb&rsquo; failed silently.. Isn&rsquo;t strace a nice tool ??</p>
<p>Okay, those who want to know why is this so&hellip; &lsquo;lsusb&rsquo; needs either /mnt/sysimage/proc/bus/usb or /mnt/sysimage/dev/bus/usb display contents to work properly. Anaconda is not mounting /mnt/sysimage/proc/bus/usb with the &lsquo;usbfs&rsquo; file system in the limited installation environment and hence &lsquo;lsusb&rsquo; fails&hellip;</p>
<p>And we have a fix for that which goes into yuminstall.py in the anaconda source :</p>
<pre><code>try:
    isys.mount(&quot;/proc/bus/usb&quot;, anaconda.rootPath + &quot;/proc/bus/usb&quot;, &quot;usbfs&quot;) 
except Exception, e:     
    log.error(&quot;error mounting usbfs: %s&quot; %(e,))
</code></pre><p>This piece of python code, tries mounting /proc/bus/usb on /mnt/sysimage/proc/bus/usb as &lsquo;usbfs. If its not possible, the code excepts an Exception error and reports &ldquo;error mounting &lsquo;usbfs&rsquo;.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/anaconda/" rel="tag">anaconda</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/installation/" rel="tag">installation</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/lsusb/" rel="tag">lsusb</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/rhel/" rel="tag">rhel</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/strace/" rel="tag">strace</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/usb/" rel="tag">usb</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 The Child is Father of the Man.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>