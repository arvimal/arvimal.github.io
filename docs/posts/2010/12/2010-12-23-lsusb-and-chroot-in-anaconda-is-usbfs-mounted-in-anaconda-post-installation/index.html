<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>lsusb and chroot in anaconda.. Is usbfs mounted in anaconda %post installation ? - The Child is Father of the Man</title><meta name="Description" content=""><meta property="og:title" content="lsusb and chroot in anaconda.. Is usbfs mounted in anaconda %post installation ?" />
<meta property="og:description" content="**T**he binary &lsquo;/sbin/lsusb&rsquo; in a chroot-ed environment have problems running properly. I have not checked this in a manually created chroot environment or using tools like &lsquo;mock&rsquo;.
The scenario is as following :
We were trying to check the output of &lsquo;lsusb&rsquo; in the %post section of a kickstart installation. I had specified &lsquo;noreboot&rsquo; in the kickstart file so the machine will wait for the user to manually reboot the machine." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://arvimal.github.io/posts/2010/12/2010-12-23-lsusb-and-chroot-in-anaconda-is-usbfs-mounted-in-anaconda-post-installation/" />
<meta property="article:published_time" content="2010-12-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2010-12-23T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="lsusb and chroot in anaconda.. Is usbfs mounted in anaconda %post installation ?"/>
<meta name="twitter:description" content="**T**he binary &lsquo;/sbin/lsusb&rsquo; in a chroot-ed environment have problems running properly. I have not checked this in a manually created chroot environment or using tools like &lsquo;mock&rsquo;.
The scenario is as following :
We were trying to check the output of &lsquo;lsusb&rsquo; in the %post section of a kickstart installation. I had specified &lsquo;noreboot&rsquo; in the kickstart file so the machine will wait for the user to manually reboot the machine."/>
<meta name="application-name" content="The Child is Father of the Man">
<meta name="apple-mobile-web-app-title" content="The Child is Father of the Man"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://arvimal.github.io/posts/2010/12/2010-12-23-lsusb-and-chroot-in-anaconda-is-usbfs-mounted-in-anaconda-post-installation/" /><link rel="prev" href="https://arvimal.github.io/posts/2010/12/2010-12-22-device-mapper-and-applications/" /><link rel="next" href="https://arvimal.github.io/posts/2014/08/2014-08-16-error-open-tmpdocker-import-repobinjson-no-such-file-or-directory/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "lsusb and chroot in anaconda.. Is usbfs mounted in anaconda %post installation ?",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/arvimal.github.io\/posts\/2010\/12\/2010-12-23-lsusb-and-chroot-in-anaconda-is-usbfs-mounted-in-anaconda-post-installation\/"
        },"genre": "posts","keywords": "anaconda, installation, lsusb, rhel, strace, usb","wordcount":  995 ,
        "url": "https:\/\/arvimal.github.io\/posts\/2010\/12\/2010-12-23-lsusb-and-chroot-in-anaconda-is-usbfs-mounted-in-anaconda-post-installation\/","datePublished": "2010-12-23T00:00:00+00:00","dateModified": "2010-12-23T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Author"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="The Child is Father of the Man">The Child is Father of the Man</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="The Child is Father of the Man">The Child is Father of the Man</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">lsusb and chroot in anaconda.. Is usbfs mounted in anaconda %post installation ?</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Author</a></span>&nbsp;<span class="post-category">included in <a href="/categories/techno/"><i class="far fa-folder fa-fw"></i>techno</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2010-12-23">2010-12-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;995 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;5 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents"></nav></div>
            </div><div class="content" id="content"><p>**<em>T</em>**he binary &lsquo;/sbin/lsusb&rsquo; in a chroot-ed environment have problems running properly. I have not checked this in a manually created chroot environment or using tools like &lsquo;mock&rsquo;.</p>
<p>The scenario is as following :</p>
<p>We were trying to check the output of &lsquo;lsusb&rsquo; in the %post section of a kickstart installation. I had specified &lsquo;noreboot&rsquo; in the kickstart file so the machine will wait for the user to manually reboot the machine. This helps to check the logs and the situation of the machine just after the installation finishes.</p>
<p>After the installation and prior to the reboot, i checked in the second available terminal (Alt + F2) created by anaconda and was astonished to see that the command &lsquo;lsusb&rsquo; does not give us the required output but an error that &lsquo;/usr/share/hwdata/usb.ids&rsquo; is not accessible or found.</p>
<p>By default, i think only the &lsquo;installation&rsquo; ie.. the %post section starts in a &lsquo;chroot&rsquo; mode and the terminal available is not chroot-ed. So we will have to use &lsquo;/mnt/sysimage/sbin/lsusb&rsquo;. This didn&rsquo;t work as expected since the &lsquo;lsusb&rsquo; binary needs to check the file &lsquo;/usr/share/hwdata/usb.ids&rsquo; and won&rsquo;t be able to find it.</p>
<p>So I did a chroot from the second terminal and did an /sbin/lsusb, since /sbin in not in the &lsquo;PATH&rsquo; by default. That too, didn&rsquo;t work out. But this time it didn&rsquo;t even complain anything. Just nothing at all, no output. Last time, at-least it complained it could not find something. So how do we go forward now ??? Here comes &lsquo;strace&rsquo; to the rescue !!!</p>
<p>strace is of-course a really nice tool to know what system calls are made and lots of internal stuff a binary will do while being executed. But &lsquo;strace&rsquo; is not installed by default on a RHEL5 machine, which is the case here. As most of you would know, anaconda creates a virtual file system which consists of most of the folders found under a linux main /. The location where the OS is installed is mounted under /mnt/sysimage.</p>
<p>Since we already have an ISO from where we have booted the machine from (DVD/CD), we are free to mount it on the filesystem, which is what we did. :</p>
<p>[sourcecode language=&ldquo;bash&rdquo; gutter=&ldquo;false&rdquo;] # mkdir /mnt/source # mount -t iso9660 /dev/hdc /mnt/source # cd /mnt/source/Server/ [/sourcecode]</p>
<p>In case you want to know how the DVD/CD drive is detected, all you need to do is execute &lsquo;dmesg&rsquo; in the available terminal. ie.. after pressing &lsquo;Alt + Ctrl + F2&rsquo;.</p>
<p>So we went forward and mounted the DVD to /mnt/source and changed the directory to /mnt/source/Server where all the rpm packages reside. Installed the package &lsquo;strace&rsquo; using an &lsquo;rpm -ivh&rsquo;. Please note that we need to use &lsquo;&ndash;root /mnt/sysimage&rsquo; as an option since we are installing the package to our newly installed file system which is at /mnt/sysimage. If this is not used, the installer will try to install the package to the virtual environment created in the memory.</p>
<p>[sourcecode language=&ldquo;bash&rdquo; gutter=&ldquo;false&rdquo;] # cd /mnt/source/Server # rpm -ivh strace-&lt;version&gt;.rpm &ndash;root /mnt/sysimage # cd # chroot /mnt/sysimage [/sourcecode]</p>
<p>This will make /mnt/sysimage as the working root, ie.. where our installation was done. OK.. now for the &lsquo;strace&rsquo; stuff.</p>
<p>[sourcecode language=&ldquo;bash&rdquo; gutter=&ldquo;false&rdquo;] # strace -fxvto strace.log -s 1024 /sbin/lsusb [/sourcecode]</p>
<p>The strace output will be saved to &lsquo;strace.log&rsquo; which we can open up in a text editor of our choice. Opening it in &lsquo;vi&rsquo;, shows a lot of stuff such as the command run, the default language, location of libraries loaded, the environment variables etc.. In this case we would only need to be interested in the last parts, ie.. to know where the binary failed :</p>
<p>[sourcecode language=&ldquo;text&rdquo; gutter=&ldquo;true&rdquo;] 15:16:17 open(&quot;/dev/bus/usb&quot;, O_RDONLY|O_NONBLOCK|O_DIRECTORY) = -1 ENOENT (No such file or directory) = 03067 15:16:17 open(&quot;/proc/bus/usb&quot;, O_RDONLY|O_NONBLOCK|O_DIRECTORY) = 33067 15:16:17 fstat(3, {st_dev=makedev(0, 3), st_ino=4026532146, st_mode=S_IFDIR|0555, st_nlink=2, st_uid=0, st_gid=0, st_blksize=4096, st_blocks=0, st_size=0, st_atime=2009/09/25-15:16:17, st_mtime=2009/09/25-15:16:17, st_ctime=2009/09/25-15:16:17}) = 03067 15:16:17 fcntl(3, F_SETFD, FD_CLOEXEC) = 03067 15:16:17 getdents(3, {{d_ino=4026532146, d_off=1, d_reclen=24, d_name=&quot;.&quot;} {d_ino=4026531879, d_off=2, d_reclen=24, d_name=&quot;..&quot;}}, 4096) = 483067 15:16:17 getdents(3, {}, 4096) = 03067 15:16:17 close(3) = 03067 15:16:17 exit_group(1) = ? [/sourcecode]</p>
<p>The above trace output shows how the &lsquo;lsusb&rsquo; binary proceeded at its last time and where it failed. We can see that it went to open &lsquo;/dev/bus/usb&rsquo;, only to find that the said location does not exist. We can understand that it is a directory from the call</p>
<p>[sourcecode language=&ldquo;text&rdquo; gutter=&ldquo;false&rdquo;] open(&quot;/dev/bus/usb&quot;, O_RDONLY|O_NONBLOCK|O_DIRECTORY) [/sourcecode]</p>
<p>Ok,, fine.. so what does it do next ?</p>
<p>As the next step, it tries to open &lsquo;/proc/bus/usb&rsquo; and it is present, which we know since there are no &lsquo;No such file or directory&rsquo; errors. Going further, the binary goes on to do a &lsquo;stat&rsquo; on &lsquo;/proc/bus/usb&rsquo;. After doing an &lsquo;fstat&rsquo;, it goes to check the file descriptor using &lsquo;fcntl&rsquo; and further goes to list the directory contents using &lsquo;getdents&rsquo;.</p>
<p>This is where we find the interesting output :</p>
<p>[sourcecode language=&ldquo;text&rdquo; gutter=&ldquo;false&rdquo;] getdents(3, {{d_ino=4026532146, d_off=1, d_reclen=24, d_name=&quot;.&quot;} {d_ino=4026531879, d_off=2, d_reclen=24, d_name=&quot;..&quot;}}, 4096) = 48 [/sourcecode]</p>
<p>As you can see in the above trace, it returns &lsquo;.&rsquo; and &lsquo;..&rsquo;, which means there are nothing in /proc/bus/usb. So what we do understand is &lsquo;lsusb&rsquo; refers /dev/bus/usb and /proc/bus/usb for its outputs.. If it was not able to find anything, strace would have given us an error which obviously would have made life much easier.</p>
<p>And that&rsquo;s how &lsquo;/sbin/lsusb&rsquo; failed silently.. Isn&rsquo;t strace a nice tool ??</p>
<p>Okay, those who want to know why is this so&hellip; &lsquo;lsusb&rsquo; needs either /mnt/sysimage/proc/bus/usb or /mnt/sysimage/dev/bus/usb display contents to work properly. Anaconda is not mounting /mnt/sysimage/proc/bus/usb with the &lsquo;usbfs&rsquo; file system in the limited installation environment and hence &lsquo;lsusb&rsquo; fails&hellip;</p>
<p>And we have a fix for that which goes into yuminstall.py in the anaconda source :</p>
<p>[sourcecode language=&ldquo;python&rdquo; gutter=&ldquo;false&rdquo;] try:     isys.mount(&quot;/proc/bus/usb&quot;, anaconda.rootPath + &ldquo;/proc/bus/usb&rdquo;, &ldquo;usbfs&rdquo;) except Exception, e:     log.error(&ldquo;error mounting usbfs: %s&rdquo; %(e,)) [/sourcecode]</p>
<p>This piece of python code, tries mounting /proc/bus/usb on /mnt/sysimage/proc/bus/usb as &lsquo;usbfs. If its not possible, the code excepts an Exception error and reports &ldquo;error mounting &lsquo;usbfs&rsquo;.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2010-12-23</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/anaconda/">anaconda</a>,&nbsp;<a href="/tags/installation/">installation</a>,&nbsp;<a href="/tags/lsusb/">lsusb</a>,&nbsp;<a href="/tags/rhel/">rhel</a>,&nbsp;<a href="/tags/strace/">strace</a>,&nbsp;<a href="/tags/usb/">usb</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2010/12/2010-12-22-device-mapper-and-applications/" class="prev" rel="prev" title="Device Mapper and applications"><i class="fas fa-angle-left fa-fw"></i>Device Mapper and applications</a>
            <a href="/posts/2014/08/2014-08-16-error-open-tmpdocker-import-repobinjson-no-such-file-or-directory/" class="next" rel="next" title="&#34;Error: open /tmp/docker-import-123456789/repo/bin/json: no such file or directory&#34;">&#34;Error: open /tmp/docker-import-123456789/repo/bin/json: no such file or directory&#34;<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.80.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
