<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>arvimal.blog - Linux, Programming</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">arvimal.blog </a></h1>
                <nav><ul>
                    <li><a href="/category/ceph.html">Ceph</a></li>
                    <li><a href="/category/ceph-programming-python.html">Ceph, Programming, Python</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming.html">Data Structures and Algorithms, Programming</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming-python.html">Data Structures and Algorithms, Programming, Python</a></li>
                    <li class="active"><a href="/category/linux-programming.html">Linux, Programming</a></li>
                    <li><a href="/category/misc.html">Misc</a></li>
                    <li><a href="/category/programming.html">Programming</a></li>
                    <li><a href="/category/programming-python.html">Programming, Python</a></li>
                    <li><a href="/category/techno.html">Techno</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/writing-a-minimalistic-kernel-module-in-linux-part-1.html">Writing a minimalistic kernel module in Linux - Part 1</a></h1>
<footer class="post-info">
        <abbr class="published" title="2017-07-27T22:34:00+02:00">
                Published: Thu 27 July 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/arvimal.html">arvimal</a>
        </address>
<p>In <a href="/category/linux-programming.html">Linux, Programming</a>.</p>
<p>tags: <a href="/tag/kernel.html">kernel</a> <a href="/tag/module.html">module</a> </p>
</footer><!-- /.post-info --><div class="section" id="introduction">
<h2>Introduction</h2>
<p><strong>L</strong>oadable Kernel Modules (LKM) are object code that can be loaded into memory, often used for supporting hardware or enable specific features. Kernel modules enable the core kernel to be minimal and have features to be loaded as required.</p>
<p>A kernel module is a normal file usually suffixed with <tt class="docutils literal">.ko</tt> denoting it's a kernel object file. It contains compiled code from one or more source files, gets linked to the kernel when loaded, and runs in kernel space. It can dynamically adds functionality to a running kernel, without requiring a reboot.</p>
<p>Linux kernel modules are written in C (not sure if anything else like C++ is possible), and is compiled for a specific kernel version. This is the ideal practice since kernel data structures may change across versions, and using a module compiled for a specific version may break for another.</p>
<p>Since kernel modules can be loaded and unloaded at will, it is pretty easy to unload an older version and load a newer one. This helps immensely in testing out new features since it is easy to change the source code, re-compile, unload the older version, load the newer version, and test the functionality.</p>
</div>
<div class="section" id="structure">
<h2>Structure</h2>
<p>Modules are expected to be under <tt class="docutils literal"><span class="pre">/lib/modules/$(uname</span> <span class="pre">-r)/</span></tt> within directories specified according to use case.</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> 3.10.0-514.26.2.el7.x86_64]# ls -l</div>
<div class="line">total 2940</div>
<div class="line">lrwxrwxrwx. 1 root root 43 Jul 8 05:10 build -&gt; /usr/src/kernels/3.10.0-514.26.2.el7.x86_64</div>
<div class="line">drwxr-xr-x. 2 root root 6 Jul 4 11:17 extra</div>
<div class="line">drwxr-xr-x. 12 root root 128 Jul 8 05:10 kernel</div>
<div class="line">-rw-r--r--. 1 root root 762886 Jul 8 05:11 modules.alias</div>
<div class="line">-rw-r--r--. 1 root root 735054 Jul 8 05:11 modules.alias.bin</div>
<div class="line">-rw-r--r--. 1 root root 1326 Jul 4 11:17 modules.block</div>
<div class="line">-rw-r--r--. 1 root root 6227 Jul 4 11:15 modules.builtin</div>
<div class="line">-rw-r--r--. 1 root root 8035 Jul 8 05:11 modules.builtin.bin</div>
<div class="line">-rw-r--r--. 1 root root 240071 Jul 8 05:11 modules.dep</div>
<div class="line">-rw-r--r--. 1 root root 343333 Jul 8 05:11 modules.dep.bin</div>
<div class="line">-rw-r--r--. 1 root root 361 Jul 8 05:11 modules.devname</div>
<div class="line">-rw-r--r--. 1 root root 132 Jul 4 11:17 modules.drm</div>
<div class="line">-rw-r--r--. 1 root root 110 Jul 4 11:17 modules.modesetting</div>
<div class="line">-rw-r--r--. 1 root root 1580 Jul 4 11:17 modules.networking</div>
<div class="line">-rw-r--r--. 1 root root 90643 Jul 4 11:15 modules.order</div>
<div class="line">-rw-r--r--. 1 root root 89 Jul 8 05:11 modules.softdep</div>
<div class="line">-rw-r--r--. 1 root root 350918 Jul 8 05:11 modules.symbols</div>
<div class="line">-rw-r--r--. 1 root root 432831 Jul 8 05:11 modules.symbols.bin</div>
<div class="line">lrwxrwxrwx. 1 root root 5 Jul 8 05:10 source -&gt; build</div>
<div class="line">drwxr-xr-x. 2 root root 6 Jul 4 11:17 updates</div>
<div class="line">drwxr-xr-x. 2 root root 95 Jul 8 05:10 vdso</div>
<div class="line">drwxr-xr-x. 2 root root 6 Jul 4 11:17 weak-updates</div>
<div class="line">[/code]</div>
</div>
<p>As we can see, there are several files that deals with the inter-dependencies of modules, which is used by <tt class="docutils literal">modprobe</tt> to understand which modules to load before the one being actually requested to load.</p>
<p>For example:</p>
<ul class="simple">
<li><tt class="docutils literal">modules.block</tt> lists the modules for block devices</li>
<li><tt class="docutils literal">modules.networking</tt> lists the ones for network devices.</li>
<li><tt class="docutils literal">modules.builtin</tt> lists the path of modules included in the kernel.</li>
<li><tt class="docutils literal">modules.devname</tt> lists the ones that would be loaded automatically if a particular device is created.</li>
</ul>
<p>The kernel&nbsp;folder contains modules divided according to their use cases.</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> 3.10.0-514.26.2.el7.x86_64]# ls -l kernel/</div>
<div class="line">total 16</div>
<div class="line">drwxr-xr-x. 3 root root 17 Jul 8 05:10 arch</div>
<div class="line">drwxr-xr-x. 3 root root 4096 Jul 8 05:10 crypto</div>
<div class="line">drwxr-xr-x. 67 root root 4096 Jul 8 05:10 drivers</div>
<div class="line">drwxr-xr-x. 26 root root 4096 Jul 8 05:10 fs</div>
<div class="line">drwxr-xr-x. 3 root root 19 Jul 8 05:10 kernel</div>
<div class="line">drwxr-xr-x. 5 root root 222 Jul 8 05:10 lib</div>
<div class="line">drwxr-xr-x. 2 root root 32 Jul 8 05:10 mm</div>
<div class="line">drwxr-xr-x. 33 root root 4096 Jul 8 05:10 net</div>
<div class="line">drwxr-xr-x. 11 root root 156 Jul 8 05:10 sound</div>
<div class="line">drwxr-xr-x. 3 root root 17 Jul 8 05:10 virt</div>
<div class="line">[/code]</div>
</div>
<p>Each directory within kernel&nbsp;contains modules depending on the area they're used for. For example, <tt class="docutils literal">kernel/fs/</tt> contains filesystem drivers.</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> 3.10.0-514.26.2.el7.x86_64]# ls -l kernel/fs</div>
<div class="line">total 48</div>
<div class="line">-rw-r--r--. 1 root root 21853 Jul 4 11:51 binfmt_misc.ko</div>
<div class="line">drwxr-xr-x. 2 root root 22 Jul 8 05:10 btrfs</div>
<div class="line">drwxr-xr-x. 2 root root 27 Jul 8 05:10 cachefiles</div>
<div class="line">drwxr-xr-x. 2 root root 21 Jul 8 05:10 ceph</div>
<div class="line">drwxr-xr-x. 2 root root 21 Jul 8 05:10 cifs</div>
<div class="line">drwxr-xr-x. 2 root root 23 Jul 8 05:10 cramfs</div>
<div class="line">drwxr-xr-x. 2 root root 20 Jul 8 05:10 dlm</div>
<div class="line">drwxr-xr-x. 2 root root 23 Jul 8 05:10 exofs</div>
<div class="line">drwxr-xr-x. 2 root root 21 Jul 8 05:10 ext4</div>
<div class="line">drwxr-xr-x. 2 root root 51 Jul 8 05:10 fat</div>
<div class="line">drwxr-xr-x. 2 root root 24 Jul 8 05:10 fscache</div>
<div class="line">drwxr-xr-x. 2 root root 36 Jul 8 05:10 fuse</div>
<div class="line">drwxr-xr-x. 2 root root 21 Jul 8 05:10 gfs2</div>
<div class="line">drwxr-xr-x. 2 root root 22 Jul 8 05:10 isofs</div>
<div class="line">drwxr-xr-x. 2 root root 21 Jul 8 05:10 jbd2</div>
<div class="line">drwxr-xr-x. 2 root root 22 Jul 8 05:10 lockd</div>
<div class="line">-rw-r--r--. 1 root root 19597 Jul 4 11:51 mbcache.ko</div>
<div class="line">drwxr-xr-x. 6 root root 128 Jul 8 05:10 nfs</div>
<div class="line">drwxr-xr-x. 2 root root 40 Jul 8 05:10 nfs_common</div>
<div class="line">drwxr-xr-x. 2 root root 21 Jul 8 05:10 nfsd</div>
<div class="line">drwxr-xr-x. 2 root root 4096 Jul 8 05:10 nls</div>
<div class="line">drwxr-xr-x. 2 root root 24 Jul 8 05:10 overlayfs</div>
<div class="line">drwxr-xr-x. 2 root root 24 Jul 8 05:10 pstore</div>
<div class="line">drwxr-xr-x. 2 root root 25 Jul 8 05:10 squashfs</div>
<div class="line">drwxr-xr-x. 2 root root 20 Jul 8 05:10 udf</div>
<div class="line">drwxr-xr-x. 2 root root 20 Jul 8 05:10 xfs</div>
<div class="line">[/code]</div>
</div>
</div>
<div class="section" id="depmod-and-related-commands">
<h2>depmod, and related commands</h2>
<p>Modules can export the features it carry, called <tt class="docutils literal">symbols</tt>&nbsp;which can be used by other modules. If module <tt class="docutils literal">A</tt>&nbsp;depends on a symbol exported by module <tt class="docutils literal">B</tt>, module <tt class="docutils literal">B</tt>&nbsp;should be loaded first followed by module <tt class="docutils literal">A</tt>.</p>
<p><tt class="docutils literal">depmod</tt>&nbsp;creates a list of symbol dependencies each module has, so that <tt class="docutils literal">modprobe</tt>&nbsp;can go ahead and load the modules serving the symbols, prior loading the actual module.</p>
<p><tt class="docutils literal">depmod</tt>&nbsp;works by:</p>
<ol class="arabic simple">
<li>Creating a list of symbols each module exports.</li>
<li>Creating a list of symbol dependencies each module has.</li>
<li>Dumping the list of symbols each module exports, to <tt class="docutils literal"><span class="pre">lib/modules/$(uname</span> <span class="pre">-r)/modules.symbols.bin</span></tt>&nbsp;and <tt class="docutils literal"><span class="pre">/lib/modules/$(uname</span> <span class="pre">-r)/modules.symbols</span></tt></li>
<li>Dumping the module dependency information to <tt class="docutils literal"><span class="pre">/lib/modules/$(uname</span> <span class="pre">-r)/modules.dep.bin</span></tt>&nbsp;and <tt class="docutils literal"><span class="pre">/lib/modules/$(uname</span> <span class="pre">-r)/modules.dep</span></tt>.</li>
<li>Creating <tt class="docutils literal"><span class="pre">/lib/modules/$(uname</span> <span class="pre">-r)/modules.devnames</span></tt>&nbsp;which contains the&nbsp;device file information (device type, major:minor number) that gets created at boot for this module to function properly.</li>
</ol>
<p><strong>NOTE</strong>:</p>
<ul class="simple">
<li><tt class="docutils literal">modprobe</tt>&nbsp;refers <tt class="docutils literal"><span class="pre">/lib/modules/$(uname</span> <span class="pre">-r)/modules.dep.bin</span></tt>&nbsp;to understand the dependencies each module require. A human-readable version of this file is maintained at <tt class="docutils literal"><span class="pre">/lib/modules/$(uname</span> <span class="pre">-r)/modules.dep</span></tt>&nbsp;but <tt class="docutils literal">modprobe</tt>&nbsp;does not refer this.</li>
<li>The binary file <tt class="docutils literal">modules.symbols.bin</tt>&nbsp;carry the symbols exported (if any) by each module, one symbol per line. A human-readable version of the same is kept at <tt class="docutils literal">modules.symbols</tt>.</li>
</ul>
<p>A sneak peek into <tt class="docutils literal">modules.symbols</tt> and <tt class="docutils literal">modules.dep</tt>:</p>
<div class="section" id="modules-symbols">
<h3>modules.symbols</h3>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> 3.10.0-514.26.2.el7.x86_64]# head modules.symbols</div>
<div class="line"># Aliases for symbols, used by symbol_request().</div>
<div class="line">alias symbol:cfg80211_report_obss_beacon cfg80211</div>
<div class="line">alias symbol:drm_dp_link_train_channel_eq_delay drm_kms_helper</div>
<div class="line">alias symbol:__twofish_setkey twofish_common</div>
<div class="line">alias symbol:mlx4_db_free mlx4_core</div>
<div class="line">alias symbol:nf_send_unreach nf_reject_ipv4</div>
<div class="line">alias symbol:sdhci_remove_host sdhci</div>
<div class="line">alias symbol:videobuf_dma_init_kernel videobuf_dma_sg</div>
<div class="line">alias symbol:ar9003_paprd_is_done ath9k_hw</div>
<div class="line">alias symbol:cxgbi_ep_disconnect libcxgbi</div>
<div class="line">[/code]</div>
</div>
</div>
<div class="section" id="modules-dep">
<h3>modules.dep</h3>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> 3.10.0-514.26.2.el7.x86_64]# head modules.dep</div>
<div class="line">kernel/arch/x86/kernel/cpu/mcheck/mce-inject.ko:</div>
<div class="line">kernel/arch/x86/kernel/test_nx.ko:</div>
<div class="line">kernel/arch/x86/kernel/iosf_mbi.ko:</div>
<div class="line">kernel/arch/x86/crypto/ablk_helper.ko: kernel/crypto/cryptd.ko</div>
<div class="line">kernel/arch/x86/crypto/glue_helper.ko:</div>
<div class="line">kernel/arch/x86/crypto/camellia-x86_64.ko: kernel/crypto/xts.ko kernel/crypto/lrw.ko kernel/crypto/gf128mul.ko kernel/arch/x86/crypto/glue_helper.ko</div>
<div class="line">kernel/arch/x86/crypto/blowfish-x86_64.ko: kernel/crypto/blowfish_common.ko</div>
<div class="line">kernel/arch/x86/crypto/twofish-x86_64.ko: kernel/crypto/twofish_common.ko</div>
<div class="line">kernel/arch/x86/crypto/twofish-x86_64-3way.ko: kernel/arch/x86/crypto/twofish-x86_64.ko kernel/crypto/twofish_common.ko kernel/crypto/xts.ko kernel/crypto/lrw.ko kernel/crypto/gf128mul.ko kernel/arch/x86/crypto/glue_helper.ko</div>
<div class="line">kernel/arch/x86/crypto/salsa20-x86_64.ko:</div>
<div class="line">[/code]</div>
</div>
<p><tt class="docutils literal">lsmod</tt>&nbsp;is a parser that reads through <tt class="docutils literal">/proc/modules</tt>&nbsp;and presents it in an easy-to-read format.</p>
<p>Note how <tt class="docutils literal">lsmod</tt>&nbsp;parse throug the content of <tt class="docutils literal">/proc/modules</tt>&nbsp;below:</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> 3.10.0-514.26.2.el7.x86_64]# head /proc/modules</div>
<div class="line">test 12498 0 - Live 0xffffffffa0492000 (POE)</div>
<div class="line">binfmt_misc 17468 1 - Live 0xffffffffa048c000</div>
<div class="line">uhid 17369 0 - Live 0xffffffffa0486000</div>
<div class="line">ipt_MASQUERADE 12678 2 - Live 0xffffffffa0481000</div>
<div class="line">nf_nat_masquerade_ipv4 13412 1 ipt_MASQUERADE, Live 0xffffffffa0451000</div>
<div class="line">xt_addrtype 12676 2 - Live 0xffffffffa044c000</div>
<div class="line">br_netfilter 22209 0 - Live 0xffffffffa0468000</div>
<div class="line">dm_thin_pool 65565 1 - Live 0xffffffffa046f000</div>
<div class="line">dm_persistent_data 67216 1 dm_thin_pool, Live 0xffffffffa0456000</div>
<div class="line">dm_bio_prison 15907 1 dm_thin_pool, Live 0xffffffffa043f000</div>
</div>
<div class="line-block">
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> 3.10.0-514.26.2.el7.x86_64]# lsmod | head</div>
<div class="line">Module Size Used by</div>
<div class="line">test 12498 0</div>
<div class="line">binfmt_misc 17468 1</div>
<div class="line">uhid 17369 0</div>
<div class="line">ipt_MASQUERADE 12678 2</div>
<div class="line">nf_nat_masquerade_ipv4 13412 1 ipt_MASQUERADE</div>
<div class="line">xt_addrtype 12676 2</div>
<div class="line">br_netfilter 22209 0</div>
<div class="line">dm_thin_pool 65565 1</div>
<div class="line">dm_persistent_data 67216 1 dm_thin_pool</div>
<div class="line">[/code]</div>
<div class="line"><strong>NOTE:</strong></div>
</div>
<ol class="arabic simple">
<li>The first field lists the module name.</li>
<li>The second field lists the size of the module in memory.</li>
<li>The third field lists the number of times the module is in use. `0` means the module is not used despite it being loaded.</li>
<li>The fourth field lists the modules which uses this module as their dependency.</li>
</ol>
</div>
</div>
<div class="section" id="creating-a-dummy-module">
<h2>Creating a dummy module</h2>
<p>The steps for creating a kernel module includes:</p>
<ol class="arabic simple">
<li>Writing the module file.</li>
<li>Writing the <tt class="docutils literal">Makefile</tt> for the module.</li>
<li>Compile the module file using <tt class="docutils literal">make</tt>&nbsp;,&nbsp;which will refer the <tt class="docutils literal">Makefile</tt> to build it.</li>
</ol>
<p>The module file and its corresponding Makefile are put in a separate directory so as to keep the kernel module directory clean. Once the module code and the Makefile are ready, the following <tt class="docutils literal">make</tt> command is used to build the module, the <tt class="docutils literal">$(PWD)</tt> being the directory where the module code and its Makefile is present.</p>
<pre class="literal-block">
# make -C /lib/modules/$(uname -r)/build M=$PWD modules
</pre>
<p>The <tt class="docutils literal">make</tt> command above does the following:</p>
<ol class="arabic simple">
<li>Change to the path mentioned after <tt class="docutils literal"><span class="pre">-C</span></tt>, ie.. to the location where the kernel Makefile is present. (<tt class="docutils literal"><span class="pre">/lib/modules/$(uname</span> <span class="pre">-r)/build/</span></tt>)</li>
<li>Use the kernel Makefile's macro <tt class="docutils literal">M</tt> which denotes the location from which the code should be compiled, ie.. in this case, the PWD where the module code/Makefile is present.</li>
<li>Use the target <tt class="docutils literal">modules</tt>&nbsp;which tells <tt class="docutils literal">make</tt>&nbsp;to build the module.</li>
</ol>
<p>Hence, the above command is trying to build a module in the current working directory, using the kernel Makefile at <tt class="docutils literal"><span class="pre">/lib/modules/$(uname</span> <span class="pre">-r)/build/Makefile</span></tt></p>
<p>If we have a module file named <tt class="docutils literal">test.c</tt>&nbsp;and its corresponding Makefile in <tt class="docutils literal">$(PWD)</tt>, the <tt class="docutils literal">make</tt>&nbsp;command would follow the steps below:</p>
<ol class="arabic simple">
<li><tt class="docutils literal">make</tt>&nbsp;calls the <tt class="docutils literal">modules</tt>&nbsp;target and refers to the kernel <tt class="docutils literal">Makefile</tt>.</li>
<li>The kernel Makefile looks for the module Makefile in $PWD.</li>
<li>The kernel Makefile read the module's Makefile and gets a list of the objects assigned to the macro <tt class="docutils literal"><span class="pre">obj-m</span></tt>.</li>
<li>The <tt class="docutils literal">make</tt>&nbsp;command builds modules for each object assigned to the macro <tt class="docutils literal"><span class="pre">obj-m</span></tt>.</li>
</ol>
</div>
<div class="section" id="writing-a-simple-module">
<h2>Writing a simple module</h2>
<p>The following is a very simple module, which prints a message while loading, and another one while unloading.</p>
<div class="line-block">
<div class="line">[code language=&quot;C&quot;]</div>
<div class="line">#include</div>
<div class="line">#include</div>
<div class="line">#include</div>
</div>
<div class="line-block">
<div class="line">int test_module(void)</div>
<div class="line">{</div>
<div class="line">&nbsp; &nbsp; printk(&quot;Loading the test module!n&quot;);</div>
<div class="line">&nbsp; &nbsp; return 0;</div>
<div class="line">}</div>
</div>
<div class="line-block">
<div class="line">void unload_test(void)</div>
<div class="line">{</div>
<div class="line">&nbsp; &nbsp; printk(&quot;Unloading the test module!n&quot;);</div>
<div class="line">}</div>
</div>
<div class="line-block">
<div class="line">module_init(test_module)</div>
<div class="line">module_exit(unload_test)</div>
<div class="line">[/code]</div>
<div class="line">This has two functions, <tt class="docutils literal">test_module()</tt>&nbsp;and <tt class="docutils literal">unload_test()</tt>&nbsp;which simply prints a text banner upon loading and unloading respectively.</div>
</div>
<p><tt class="docutils literal">module_init()</tt>&nbsp;is&nbsp;used to load the module, and can call whatever functions that needs to initialize the module. We load our <tt class="docutils literal">test_module()</tt>&nbsp;function into <tt class="docutils literal">module_init()</tt>&nbsp;so that it gets initialized when the module is loaded.</p>
<p><tt class="docutils literal">module_exit()</tt>&nbsp;is called whenever the module has to be unloaded, and it can take in whatever functions are required to do a proper cleanup (if required) prior the module being unloaded. We load our <tt class="docutils literal">unload_test()</tt>&nbsp;function in <tt class="docutils literal">module_exit()</tt>.</p>
</div>
<div class="section" id="writing-a-makefile">
<h2>Writing a Makefile</h2>
<p>Since the kernel Makefile will look in for the <tt class="docutils literal"><span class="pre">obj-m</span></tt> macro in the module Makefile with the object filename as its argument, add the following in the Makefile:</p>
<div class="line-block">
<div class="line">[code language=&quot;text&quot;]</div>
<div class="line">obj-m := test.o</div>
<div class="line">[/code]</div>
</div>
<p><tt class="docutils literal">make</tt> will create an object file <tt class="docutils literal">test.o</tt> from <tt class="docutils literal">test.c</tt>, and then create a kernel object file <tt class="docutils literal">test.ko</tt>.</p>
</div>
<div class="section" id="compiling-the-module-with-make">
<h2>Compiling the module with `make`</h2>
<p>Let's compile the module</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> test]# pwd</div>
<div class="line">/lib/modules/3.10.0-514.26.2.el7.x86_64/test</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> test]# ls</div>
<div class="line">Makefile test.c</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> test]# make -C /lib/modules/$(uname -r)/build M=$PWD modules</div>
<div class="line">make: Entering directory `/usr/src/kernels/3.10.0-514.26.2.el7.x86_64'</div>
<div class="line">CC [M] /lib/modules/3.10.0-514.26.2.el7.x86_64/test/test.o</div>
<div class="line">Building modules, stage 2.</div>
<div class="line">MODPOST 1 modules</div>
<div class="line">CC /lib/modules/3.10.0-514.26.2.el7.x86_64/test/test.mod.o</div>
<div class="line">LD [M] /lib/modules/3.10.0-514.26.2.el7.x86_64/test/test.ko</div>
<div class="line">make: Leaving directory `/usr/src/kernels/3.10.0-514.26.2.el7.x86_64'</div>
<div class="line">[/code]</div>
<div class="line">Listing the contents show lot of new files, including the module code, the Makefile, the object file <tt class="docutils literal">test.o</tt> created from <tt class="docutils literal">test.c</tt>, the kernel object file <tt class="docutils literal">test.ko</tt>.</div>
</div>
<p><tt class="docutils literal">test.mod.c</tt> contains code which should be the one ultimately being built to <tt class="docutils literal">test.ko</tt>, but that should be for another post since much more is yet to be read/learned on what's happening there.</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> test]# ls -l</div>
<div class="line">total 292</div>
<div class="line">-rw-r--r--. 1 root root 16 Jul 27 11:52 Makefile</div>
<div class="line">-rw-r--r--. 1 root root 60 Jul 27 11:57 modules.order</div>
<div class="line">-rw-r--r--. 1 root root 0 Jul 27 11:57 Module.symvers</div>
<div class="line">-rw-r--r--. 1 root root 281 Jul 27 11:53 test.c</div>
<div class="line">-rw-r--r--. 1 root root 137768 Jul 27 11:57 test.ko</div>
<div class="line">-rw-r--r--. 1 root root 787 Jul 27 11:57 test.mod.c</div>
<div class="line">-rw-r--r--. 1 root root 52912 Jul 27 11:57 test.mod.o</div>
<div class="line">-rw-r--r--. 1 root root 87776 Jul 27 11:57 test.o</div>
<div class="line">[/code]</div>
</div>
</div>
<div class="section" id="loading-unloading-the-module">
<h2>Loading/Unloading the module</h2>
<p>Loading and unloading the module should print the messages passed via <tt class="docutils literal">printk</tt> in <tt class="docutils literal">dmesg</tt>.</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> test]# insmod ./test.ko</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> test]# lsmod | grep test</div>
<div class="line">test 12498 0</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> test]# rmmod test</div>
<div class="line">[/code]</div>
</div>
<p>Checking <tt class="docutils literal">dmesg</tt> shows the informational messages in the module code:</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line">[<a class="reference external" href="mailto:root&#64;centos7">root&#64;centos7</a> test]# dmesg | tail</div>
<div class="line">[35889.187282] test: loading out-of-tree module taints kernel.</div>
<div class="line">[35889.187288] test: module license 'unspecified' taints kernel.</div>
<div class="line">[35889.187290] Disabling lock debugging due to kernel taint</div>
<div class="line">[35889.187338] test: module verification failed: signature and/or required key missing - tainting kernel</div>
<div class="line">[35889.187548] Loading the test module!</div>
<div class="line">[35899.216954] Unloading the test module!</div>
<div class="line">[/code]</div>
<div class="line">Note the messages about the module <tt class="docutils literal">test</tt> tainting the kernel. Read more on how a module can taint the kernel, at&nbsp;<a class="reference external" href="https://www.kernel.org/doc/html/latest/admin-guide/tainted-kernels.html">https://www.kernel.org/doc/html/latest/admin-guide/tainted-kernels.html.</a></div>
</div>
<p>More on customizing the Makefile in another post.</p>
</div>
                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>