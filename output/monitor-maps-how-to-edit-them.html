<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <title>"Monitor maps, how to edit them?" - arvimal.github.io</title>
    <meta name="description" content="">
    <meta name="author" content="Vimal A.R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="https://arvimal.github.io/theme/html5.js"></script>
    <![endif]-->


    <!-- Le styles -->
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/css/bootstrap.no-icons.min.css" rel="stylesheet">
    <link href="https://arvimal.github.io/theme/local.css" rel="stylesheet">
    <link href="https://arvimal.github.io/theme/pygments.css" rel="stylesheet">
    <link href="https://arvimal.github.io/theme/font-awesome.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Gudea:400,400italic|Alegreya+SC' rel='stylesheet' type='text/css'>

</head>

<body>
<header class="blog-header">
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
	<a href="https://arvimal.github.io" class="brand">arvimal.github.io</a>
      </div>

      <div class="span3" id="blog-nav">
	<ul class="nav nav-pills pull-right">
	    <li  class="active" >
	      <a href="https://arvimal.github.io/category/misc.html ">misc</a>
	</ul>
      </div>
    </div> <!-- End of fluid row-->
  </div>   <!-- End of Container-->
</header>
    
<div class="container">
    <div class="content">
    <div class="row-fluid">

        <div class="span10">
    <div class='article'>
      <div class="row-fluid">
           <div class="content-title span9">
             <h1>"Monitor maps, how to edit them?"</h1>
           </div>
      </div>
    <div class="row-fluid">
      <div class="span2">
<p>September 01, 2015 </p>

<p style="text-align: left;">
Filed under <a href="https://arvimal.github.io/category/misc.html">misc</a>
</p>
<p style="text-align: left;">
</p>
<p>
</p>
      </div>
      
      <div class="span8">
	<ul>
<li>"ceph"
tags:</li>
<li>"ceph"</li>
<li>"monitors"</li>
<li>"monmaptool"</li>
</ul>
<hr>
<p>The <strong>MON map</strong> is used by the monitors in a Ceph cluster, where they keep track of various attributes relevant to the working of the cluster.</p>
<p>Similar to the <a href="http://ceph.com/papers/weil-crush-sc06.pdf">CRUSH</a> map, a monitor map can be pulled out of the cluster, inspected, changed, and injected back to the monitors, manually. A frequent use-case is when the IP address of a monitor changes and the monitors cannot agree on a quorum.</p>
<p>Monitors use the monitor map (<strong>monmap</strong>) to get the details of other monitors. So just changing the monitor address in '<strong>ceph.conf</strong>' and pushing the configuration to all the nodes won't help to propagate the changes.</p>
<p>In most cases, starting the monitor with a wrong monitor map would make the monitors commit suicide, since they would find conflicting information about themself in the mon map due to the IP address change.</p>
<p>There are two methods to fix this problem, the first being adding enough new monitors, let them form a quorum, and remove the faulty monitors. This doesn't need any explanation. The second and more crude way, is to edit the monitor map directly, set the new IP address, and upload the monmap back to the monitors.</p>
<p>This article discusses the second method, ie.. how to edit the monmap, and re-inject it back. This can be done using the '<strong>monmap</strong>' tool.</p>
<p>1. As the first step, login to one of the monitors, and get the monitor map:</p>
<blockquote>
<p><strong># ceph mon getmap -o /tmp/monitor_map.bin</strong></p>
</blockquote>
<p>2. Inspect what the monitor map contains:</p>
<blockquote>
<p><strong># monmaptool --print /tmp/monitor_map.bin</strong></p>
</blockquote>
<ul>
<li>An example from my cluster :</li>
</ul>
<blockquote>
<p><strong># monmaptool --print monmap</strong></p>
<p>monmaptool: monmap file monmap epoch 1 fsid d978794d-5835-4ac3-8fe3-3855b18b9572 last_changed 0.000000 created 0.000000 0: 192.168.122.73:6789/0 mon.node2</p>
</blockquote>
<p>3. Remove the node which has the wrong IP address, referring it's hostname</p>
<blockquote>
<p><strong># monmaptool --rm node2 /tmp/monitor_map.bin</strong></p>
</blockquote>
<p>4. Inspect the monitor map to see if the monitor is indeed removed.</p>
<blockquote>
<p><strong># monmaptool --print /tmp/monitor_map.bin</strong></p>
<p>monmaptool: monmap file monmap epoch 1 fsid d978794d-5835-4ac3-8fe3-3855b18b9572 last_changed 0.000000 created 0.000000</p>
</blockquote>
<p>5. Add a new monitor (or the existing monitor with it's new IP)</p>
<blockquote>
<p><strong># monmaptool --add node3  192.168.122.76:6789  /tmp/monitor_map.bin</strong></p>
<p>monmaptool: monmap file monmap monmaptool: writing epoch 1 to monmap (1 monitors)</p>
</blockquote>
<p>6. Check the monitor map to confirm the changes</p>
<blockquote>
<p><strong># monmaptool --print monmap</strong></p>
<p>monmaptool: monmap file monmap epoch 1 fsid d978794d-5835-4ac3-8fe3-3855b18b9572 last_changed 0.000000 created 0.000000 0: 192.168.122.76:6789/0 mon.node3</p>
</blockquote>
<p>7. Make sure the mon processes are not running on the monitor nodes</p>
<blockquote>
<p><strong># service ceph stop mon</strong></p>
</blockquote>
<p>8. Upload the changes</p>
<blockquote>
<p><strong># ceph-mon -i monitor_node --inject-monmap /tmp/mon_map.bin</strong></p>
</blockquote>
<p>9. Start the mon process on each monitor</p>
<blockquote>
<p><strong># service ceph start mon</strong></p>
</blockquote>
<p>10. Check if the cluster has taken in the changes.</p>
<blockquote>
<p><strong># ceph -s</strong></p>
</blockquote>
	<hr />
      </div>
    </div>
    <div class="span10">
      <h3>Comments</h3>
    
    </div>  
    </div>
        </div>
        
        
    </div>     </div> </div>

<!--footer-->
<div class="container">
  <div class="well" style="background-color: #E9EFF6">
    <div id="blog-footer">
      <div class="row-fluid">
	<div class="social span2" align="center" id="socialist">
	  <ul class="nav nav-list">
	    <li class="nav-header">
	      Social
	    </li>
	    <li><a href="https://github.com/arvimal"><i class="icon-GitHub" style="color: #1f334b"></i>GitHub</a></li>
	    <li><a href="https://www.linkedin.com/in/arvimal/"><i class="icon-LinkedIn" style="color: #1f334b"></i>LinkedIn</a></li>
	    <li><a href="https://arvimal.blog/"><i class="icon-Blog" style="color: #1f334b"></i>Blog</a></li>

	  </ul>
	</div>
	<div class="site-nav span2" align="center">
          <ul class="nav nav-list" id="site-links">
            <li class="nav-header"> 
              Site
            </li>
            <li><a href="https://arvimal.github.io"><i class="icon-home" style="color: #1f334b">
                </i>Home</a></li>
            <li><a href="https://arvimal.github.io/archives.html"><i class="icon-list" style="color: #1f334b">
                </i>Archives</a></li>
	    <li><a href="https://arvimal.github.io/tags.html"><i class="icon-tags" style="color: #1f334b">
                </i>Tags</a></li>
	    
	  </ul>

        </div>

      </div> <!--end of fluid row-->
    </div> <!--end of blog-footer-->
    <hr />
    <p align="center"><a href="https://arvimal.github.io">arvimal.github.io</a>
      &copy; Vimal A.R
    Powered by <a href="https://github.com/getpelican/pelican">Pelican</a> and
        <a href="https://twitter.github.com/bootstrap">Twitter Bootstrap</a>. 
        Icons by <a href="https://fortawesome.github.com/Font-Awesome">Font Awesome</a> and 
        <a href="https://gregoryloucas.github.com/Font-Awesome-More">Font Awesome More</a></p>

  </div> <!--end of well -->
</div> <!--end of container -->

<!--/footer-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>



</body>
</html>