<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Monitor maps, how to edit them?</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">arvimal.blog </a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/ceph.html">Ceph</a></li>
                    <li><a href="/category/ceph-programming-python.html">Ceph, Programming, Python</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming.html">Data Structures and Algorithms, Programming</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming-python.html">Data Structures and Algorithms, Programming, Python</a></li>
                    <li><a href="/category/linux-programming.html">Linux, Programming</a></li>
                    <li><a href="/category/misc.html">Misc</a></li>
                    <li><a href="/category/programming.html">Programming</a></li>
                    <li><a href="/category/programming-python.html">Programming, Python</a></li>
                    <li><a href="/category/techno.html">Techno</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/how-to-extract-view-change-and-inject-a-monitor-map-in-a-ceph-cluster.html" rel="bookmark"
           title="Permalink to Monitor maps, how to edit them?">Monitor maps, how to edit them?</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-09-01T12:54:00+02:00">
                Published: Tue 01 September 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/arvimal.html">arvimal</a>
        </address>
<p>In <a href="/category/ceph.html">Ceph</a>.</p>
<p>tags: <a href="/tag/ceph.html">ceph</a> <a href="/tag/monitors.html">monitors</a> <a href="/tag/monmaptool.html">monmaptool</a> </p>
</footer><!-- /.post-info -->      <p>The <strong>MON map</strong> is used by the monitors in a Ceph cluster, where they keep track of various attributes relevant to the working of the cluster.</p>
<p>Similar to the <a class="reference external" href="http://ceph.com/papers/weil-crush-sc06.pdf">CRUSH</a>&nbsp;map, a monitor map can be pulled out of the cluster, inspected, changed, and injected back to the monitors, manually. A frequent use-case is when the IP address of a monitor changes and the monitors cannot agree on a quorum.</p>
<p>Monitors use the monitor map (<strong>monmap</strong>) to get the details of other monitors. So just changing the monitor address in '<strong>ceph.conf</strong>' and pushing the configuration to all the nodes won't help to propagate the changes.</p>
<p>In most cases, starting the monitor with a wrong monitor map would make the monitors commit suicide, since they would find conflicting information about themself in the mon map due to the IP address change.</p>
<p>There are two methods to fix this problem, the first being adding enough new monitors, let them form a quorum, and remove the faulty&nbsp;monitors. This doesn't need any explanation. The second and more crude way, is to edit the monitor map directly, set the new IP address, and upload the monmap back to the monitors.</p>
<p>This article discusses the second method, ie.. how to edit the monmap, and re-inject it back. This can be done using the '<strong>monmap</strong>' tool.</p>
<ol class="arabic">
<li><p class="first">As the first step, login to one of the monitors, and get the monitor map:</p>
<p><strong># ceph mon getmap -o /tmp/monitor_map.bin</strong></p>
</li>
<li><p class="first">Inspect what the monitor map contains:</p>
<p><strong># monmaptool --print /tmp/monitor_map.bin</strong></p>
</li>
</ol>
<ul class="simple">
<li>An example from my cluster :</li>
</ul>
<!--  -->
<blockquote>
<p><strong># monmaptool --print monmap</strong></p>
<div class="line-block">
<div class="line">monmaptool: monmap file monmap epoch 1</div>
<div class="line">fsid d978794d-5835-4ac3-8fe3-3855b18b9572</div>
<div class="line">last_changed 0.000000 created 0.000000</div>
<div class="line">0: 192.168.122.73:6789/0 mon.node2</div>
</div>
</blockquote>
<ol class="arabic" start="3">
<li><p class="first">Remove the node which has the wrong IP address, referring it's hostname</p>
<p><strong># monmaptool --rm node2 /tmp/monitor_map.bin</strong></p>
</li>
<li><p class="first">Inspect the monitor map to see if the monitor is indeed removed.</p>
<p><strong># monmaptool --print /tmp/monitor_map.bin</strong></p>
<div class="line-block">
<div class="line">monmaptool: monmap file monmap epoch 1</div>
<div class="line">fsid d978794d-5835-4ac3-8fe3-3855b18b9572</div>
<div class="line">last_changed 0.000000 created 0.000000</div>
</div>
</li>
<li><p class="first">Add a new monitor (or the existing monitor with it's new IP)</p>
<p><strong># monmaptool --add node3&nbsp; 192.168.122.76:6789&nbsp; /tmp/monitor_map.bin</strong></p>
<div class="line-block">
<div class="line">monmaptool: monmap file monmap</div>
<div class="line">monmaptool: writing epoch 1 to monmap (1 monitors)</div>
</div>
</li>
<li><p class="first">Check the monitor map to confirm the changes</p>
<p><strong># monmaptool --print monmap</strong></p>
<div class="line-block">
<div class="line">monmaptool: monmap file monmap epoch 1</div>
<div class="line">fsid d978794d-5835-4ac3-8fe3-3855b18b9572</div>
<div class="line">last_changed 0.000000 created 0.000000</div>
<div class="line">0: 192.168.122.76:6789/0 mon.node3</div>
</div>
</li>
<li><p class="first">Make sure the mon processes are not running on the monitor nodes</p>
<p><strong># service ceph stop mon</strong></p>
</li>
<li><p class="first">Upload the changes</p>
<p><strong># ceph-mon -i monitor_node --inject-monmap /tmp/mon_map.bin</strong></p>
</li>
<li><p class="first">Start the mon process on each monitor</p>
<p><strong># service ceph start mon</strong></p>
</li>
<li><p class="first">Check if the cluster has taken in the changes.</p>
</li>
</ol>
<blockquote>
<strong># ceph -s</strong></blockquote>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>