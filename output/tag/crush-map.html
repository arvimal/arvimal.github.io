<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>arvimal.blog - crush map</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">arvimal.blog </a></h1>
                <nav><ul>
                    <li><a href="/category/ceph.html">Ceph</a></li>
                    <li><a href="/category/ceph-programming-python.html">Ceph, Programming, Python</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming.html">Data Structures and Algorithms, Programming</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming-python.html">Data Structures and Algorithms, Programming, Python</a></li>
                    <li><a href="/category/linux-programming.html">Linux, Programming</a></li>
                    <li><a href="/category/misc.html">Misc</a></li>
                    <li><a href="/category/programming.html">Programming</a></li>
                    <li><a href="/category/programming-python.html">Programming, Python</a></li>
                    <li><a href="/category/techno.html">Techno</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/how-to-remove-a-host-from-a-ceph-cluster.html">How to remove a host from a Ceph cluster?</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-05-07T19:56:00+02:00">
                Published: Thu 07 May 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/arvimal.html">arvimal</a>
        </address>
<p>In <a href="/category/ceph.html">Ceph</a>.</p>
<p>tags: <a href="/tag/ceph.html">ceph</a> <a href="/tag/crush.html">crush</a> <a href="/tag/crush-map.html">crush map</a> <a href="/tag/osd.html">osd</a> </p>
</footer><!-- /.post-info --><p>I'm still studying Ceph, and recently faced a scenario in which one of my Ceph nodes went down due to hardware failure. Even though my data was safe due to the replication factor, I was not able to remove the node from the cluster.</p>
<p>I could remove the OSDs on the node, but I didn't find a way to remove the node being listed in 'ceph osd tree'. I ended up editing the CRUSH map by hand, to remove the host, and uploaded it back. This worked as expected. Following are the steps I did to achieve this.</p>
<ol class="loweralpha simple">
<li>This was the state just after the node went down:</li>
</ol>
<p>[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</p>
<p># ceph osd tree</p>
<div class="line-block">
<div class="line"># id &nbsp;&nbsp;&nbsp; weight&nbsp;&nbsp;&nbsp; type &nbsp;&nbsp;&nbsp; name&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; up/down&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; reweight</div>
<div class="line">-10&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .08997&nbsp;&nbsp;&nbsp; root &nbsp;&nbsp;&nbsp; default</div>
<div class="line">-20&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .01999&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; host hp-m300-5</div>
<div class="line">00&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .009995&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; osd.0&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; up &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 1</div>
<div class="line">40&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .009995&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; osd.4&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; up &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 1</div>
<div class="line">-30&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .009995&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; host hp-m300-9</div>
<div class="line">10&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .009995&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; osd.1 &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; down &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0</div>
<div class="line">-40&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .05998&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; host hp-m300-4</div>
<div class="line">20&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .04999&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; osd.2&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; up &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 1</div>
<div class="line">30&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .009995&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; osd.3&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; up &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 1</div>
</div>
<p>[/sourcecode]</p>
<p>[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</p>
<p># ceph -w</p>
<div class="line-block">
<div class="line">cluster 62a6a880-fb65-490c-bc98-d689b4d1a3cb</div>
<div class="line">&nbsp;&nbsp;&nbsp; health HEALTH_WARN 64 pgs degraded; 64 pgs stuck unclean; recovery 261/785 objects degraded (33.248%)</div>
<div class="line">&nbsp;&nbsp;&nbsp; monmap e1: 1 mons at {hp-m300-4=10.65.200.88:6789/0}, election epoch 1, quorum 0 hp-m300-4</div>
<div class="line">&nbsp;&nbsp;&nbsp; osdmap e130: 5 osds: 4 up, 4 in</div>
<div class="line">&nbsp;&nbsp;&nbsp; pgmap v8465: 196 pgs, 4 pools, 1001 MB data, 262 objects</div>
<div class="line">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 7672 MB used, 74192 MB / 81865 MB avail</div>
<div class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 261/785 objects degraded (33.248%)</div>
<div class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 64 active+degraded</div>
<div class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 132 active+clean</div>
<div class="line">[/sourcecode]</div>
</div>
<p>I started with marking the OSDs on the node out, and removing them. Note that I don't need to stop the OSD (osd.1) since the node carrying osd.1 is down and not accessible.</p>
<ol class="loweralpha simple" start="2">
<li>If not, you would've to stop the OSD using:</li>
</ol>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># sudo service osd stop osd.1</div>
<div class="line">[/sourcecode]</div>
</div>
<ol class="loweralpha simple" start="3">
<li>Mark the OSD out, this is not ideally needed in this case since the node is already out.</li>
</ol>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># ceph osd out osd.1</div>
<div class="line">[/sourcecode]</div>
</div>
<ol class="loweralpha simple" start="4">
<li>Remove the OSD from the CRUSH map, so that it does not receive any data. You can also get the crushmap, de-compile it, remove the OSD, re-compile, and upload it back.</li>
</ol>
<p>Remove item id 1 with the name 'osd.1' from the CRUSH map.</p>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># ceph osd crush remove osd.1</div>
<div class="line">[/sourcecode]</div>
</div>
<ol class="loweralpha simple" start="5">
<li>Remove the OSD authentication key</li>
</ol>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># ceph auth del osd.1</div>
<div class="line">[/sourcecode]</div>
</div>
<ol class="loweralpha simple" start="6">
<li>At this stage, I had to remove the OSD host from the listing but was not able to find a way to do so. The 'ceph-deploy' didn't have any tools to do this, other than 'purge', and 'uninstall'. Since the node was not f) accessible, these won't work anyways. A 'ceph-deploy purge' failed with the following errors, which is expected since the node is not accessible.</li>
</ol>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># ceph-deploy purge hp-m300-9</div>
</div>
<div class="line-block">
<div class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /root/.cephdeploy.conf</div>
<div class="line">[ceph_deploy.cli][INFO&nbsp; ] Invoked (1.5.22-rc1): /usr/bin/ceph-deploy purge hp-m300-9</div>
<div class="line">[ceph_deploy.install][INFO&nbsp; ] note that some dependencies *will not* be removed because they can cause issues with qemu-kvm</div>
<div class="line">[ceph_deploy.install][INFO&nbsp; ] like: librbd1 and librados2</div>
<div class="line">[ceph_deploy.install][DEBUG ] Purging from cluster ceph hosts hp-m300-9</div>
<div class="line">[ceph_deploy.install][DEBUG ] Detecting platform for host hp-m300-9 ...</div>
<div class="line">ssh: connect to host hp-m300-9 port 22: No route to host</div>
<div class="line">[ceph_deploy][ERROR ] RuntimeError: connecting to host: hp-m300-9 resulted in errors: HostNotFound hp-m300-9</div>
</div>
<p>[/sourcecode]</p>
<p>I ended up fetching the CRUSH map, removing the OSD host from it, and uploading it back.</p>
<ol class="loweralpha simple" start="7">
<li>Get the CRUSH map</li>
</ol>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># ceph osd getcrushmap -o /tmp/crushmap</div>
<div class="line">[/sourcecode]</div>
</div>
<ol class="loweralpha simple" start="8">
<li>De-compile the CRUSH map</li>
</ol>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># crushtool -d /tmp/crushmap -o crush_map</div>
<div class="line">[/sourcecode]</div>
</div>
<ol class="lowerroman simple">
<li>I had to remove the entries pertaining to the host-to-be-removed from the following sections:</li>
</ol>
<div class="line-block">
<div class="line">a) devices</div>
<div class="line">b) types</div>
<div class="line">c) And from the 'root' default section as well.</div>
</div>
<ol class="loweralpha simple" start="10">
<li>Once I had the entries removed, I went ahead compiling the map, and inserted it back.</li>
</ol>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># crushtool -c crush_map -o /tmp/crushmap</div>
<div class="line"># ceph osd setcrushmap -i /tmp/crushmap</div>
<div class="line">[/sourcecode]</div>
</div>
<ol class="loweralpha simple" start="11">
<li>A 'ceph osd tree' looks much cleaner now :)</li>
</ol>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># ceph osd tree</div>
</div>
<div class="line-block">
<div class="line"># id &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; weight &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; type &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; name&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; up/down&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; reweight</div>
<div class="line">-1 &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0.07999&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; root &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; default</div>
<div class="line">-2&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0.01999&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; host hp-m300-5</div>
<div class="line">0&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0.009995&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; osd.0&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; down&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0</div>
<div class="line">4&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0.009995&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; osd.4 &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; down &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0</div>
<div class="line">-4&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0.06&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; host hp-m300-4</div>
<div class="line">2&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0.04999&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; osd.2 &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; up &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 1</div>
<div class="line">3&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0.009995&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; osd.3 &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; up &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 1</div>
<div class="line">[/sourcecode]</div>
</div>
<p>There may be a more direct method to remove the OSD host from the listing. I'm not aware of anything relevant, based on my limited knowledge. Perhaps I'll come across something as I progress with Ceph. Comments welcome.</p>
                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>