<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>arvimal.blog - rhel</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">arvimal.blog </a></h1>
                <nav><ul>
                    <li><a href="/category/ceph.html">Ceph</a></li>
                    <li><a href="/category/ceph-programming-python.html">Ceph, Programming, Python</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming.html">Data Structures and Algorithms, Programming</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming-python.html">Data Structures and Algorithms, Programming, Python</a></li>
                    <li><a href="/category/linux-programming.html">Linux, Programming</a></li>
                    <li><a href="/category/misc.html">Misc</a></li>
                    <li><a href="/category/programming.html">Programming</a></li>
                    <li><a href="/category/programming-python.html">Programming, Python</a></li>
                    <li><a href="/category/techno.html">Techno</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/lsusb-and-chroot-in-anaconda-is-usbfs-mounted-in-anaconda-post-installation.html">lsusb and chroot in anaconda.. Is usbfs mounted in anaconda %post installation ?</a></h1>
<footer class="post-info">
        <abbr class="published" title="2010-12-23T07:53:00+01:00">
                Published: Thu 23 December 2010
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/arvimal.html">arvimal</a>
        </address>
<p>In <a href="/category/techno.html">Techno</a>.</p>
<p>tags: <a href="/tag/anaconda.html">anaconda</a> <a href="/tag/installation.html">installation</a> <a href="/tag/lsusb.html">lsusb</a> <a href="/tag/rhel.html">rhel</a> <a href="/tag/strace.html">strace</a> <a href="/tag/usb.html">usb</a> </p>
</footer><!-- /.post-info --><p><strong>T</strong>he binary '/sbin/lsusb' in a chroot-ed environment have problems running properly. I have not checked this in a manually created chroot environment or using tools like 'mock'.</p>
<p>The scenario is as following :</p>
<p>We were trying to check the output of 'lsusb' in the %post section of a kickstart installation. I had specified 'noreboot' in the kickstart file so the machine will wait for the user to manually reboot the machine. This helps to check the logs and the situation of the machine just after the installation finishes.</p>
<p>After the installation and prior to the reboot, i checked in the second available terminal (Alt + F2) created by anaconda and was astonished to see that the command 'lsusb' does not give us the required output but an error that '/usr/share/hwdata/usb.ids' is not accessible or found.</p>
<p>By default, i think only the 'installation' ie.. the %post section starts in a 'chroot' mode and the terminal available is not chroot-ed. So we will have to use '/mnt/sysimage/sbin/lsusb'. This didn't work as expected since the 'lsusb' binary needs to check the file '/usr/share/hwdata/usb.ids' and won't be able to find it.</p>
<p>So I did a chroot from the second terminal and did an /sbin/lsusb, since /sbin in not in the 'PATH' by default. That too, didn't work out. But this time it didn't even complain anything. Just nothing at all, no output. Last time, at-least it complained it could not find something. So how do we go forward now ??? Here comes 'strace' to the rescue !!!</p>
<p>strace is of-course a really nice tool to know what system calls are made and lots of internal stuff a binary will do while being executed. But 'strace' is not installed by default on a RHEL5 machine, which is the case here. As most of you would know, anaconda creates a virtual file system which consists of most of the folders found under a linux main /. The location where the OS is installed is mounted under /mnt/sysimage.</p>
<p>Since we already have an ISO from where we have booted the machine from (DVD/CD), we are free to mount it on the filesystem, which is what we did. :</p>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># mkdir /mnt/source</div>
<div class="line"># mount -t iso9660 /dev/hdc /mnt/source</div>
<div class="line"># cd /mnt/source/Server/</div>
<div class="line">[/sourcecode]</div>
</div>
<p>In case you want to know how the DVD/CD drive is detected, all you need to do is execute 'dmesg' in the available terminal. ie.. after pressing 'Alt + Ctrl + F2'.</p>
<p>So we went forward and mounted the DVD to /mnt/source and changed the directory to /mnt/source/Server where all the rpm packages reside. Installed the package 'strace' using an 'rpm -ivh'. Please note that we need to use '--root /mnt/sysimage' as an option since we are installing the package to our newly installed file system which is at /mnt/sysimage. If this is not used, the installer will try to install the package to the virtual environment created in the memory.</p>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># cd /mnt/source/Server</div>
<div class="line"># rpm -ivh strace-&amp;lt;version&amp;gt;.rpm --root /mnt/sysimage</div>
<div class="line"># cd</div>
<div class="line"># chroot /mnt/sysimage</div>
<div class="line">[/sourcecode]</div>
</div>
<p>This will make /mnt/sysimage as the working root, ie.. where our installation was done. OK.. now for the 'strace' stuff.</p>
<div class="line-block">
<div class="line">[sourcecode language=&quot;bash&quot; gutter=&quot;false&quot;]</div>
<div class="line"># strace -fxvto strace.log -s 1024 /sbin/lsusb</div>
<div class="line">[/sourcecode]</div>
</div>
<p>The strace output will be saved to 'strace.log' which we can open up in a text editor of our choice. Opening it in 'vi', shows a lot of stuff such as the command run, the default language, location of libraries loaded, the environment variables etc.. In this case we would only need to be interested in the last parts, ie.. to know where the binary failed :</p>
<div class="line-block">
<div class="line">[sourcecode language=&quot;text&quot; gutter=&quot;true&quot;]</div>
<div class="line">15:16:17 open(&quot;/dev/bus/usb&quot;, O_RDONLY|O_NONBLOCK|O_DIRECTORY) = -1 ENOENT (No such file or directory) = 03067</div>
<div class="line">15:16:17 open(&quot;/proc/bus/usb&quot;, O_RDONLY|O_NONBLOCK|O_DIRECTORY) = 33067</div>
<div class="line">15:16:17 fstat(3, {st_dev=makedev(0, 3), st_ino=4026532146, st_mode=S_IFDIR|0555, st_nlink=2, st_uid=0, st_gid=0, st_blksize=4096, st_blocks=0, st_size=0, st_atime=2009/09/25-15:16:17, st_mtime=2009/09/25-15:16:17, st_ctime=2009/09/25-15:16:17}) = 03067</div>
<div class="line">15:16:17 fcntl(3, F_SETFD, FD_CLOEXEC) = 03067</div>
<div class="line">15:16:17 getdents(3, {{d_ino=4026532146, d_off=1, d_reclen=24, d_name=&quot;.&quot;} {d_ino=4026531879, d_off=2, d_reclen=24, d_name=&quot;..&quot;}}, 4096) = 483067</div>
<div class="line">15:16:17 getdents(3, {}, 4096) = 03067</div>
<div class="line">15:16:17 close(3) = 03067</div>
<div class="line">15:16:17 exit_group(1) = ?</div>
<div class="line">[/sourcecode]</div>
</div>
<p>The above trace output shows how the 'lsusb' binary proceeded at its last time and where it failed. We can see that it went to open '/dev/bus/usb', only to find that the said location does not exist. We can understand that it is a directory from the call</p>
<div class="line-block">
<div class="line">[sourcecode language=&quot;text&quot; gutter=&quot;false&quot;]</div>
<div class="line">open(&quot;/dev/bus/usb&quot;, O_RDONLY|O_NONBLOCK|O_DIRECTORY)</div>
<div class="line">[/sourcecode]</div>
</div>
<p>Ok,, fine.. so what does it do next ?</p>
<p>As the next step, it tries to open '/proc/bus/usb' and it is present, which we know since there are no 'No such file or directory' errors. Going further, the binary goes on to do a 'stat' on '/proc/bus/usb'. After doing an 'fstat', it goes to check the file descriptor using 'fcntl' and further goes to list the directory contents using 'getdents'.</p>
<p>This is where we find the interesting output :</p>
<div class="line-block">
<div class="line">[sourcecode language=&quot;text&quot; gutter=&quot;false&quot;]</div>
<div class="line">getdents(3, {{d_ino=4026532146, d_off=1, d_reclen=24, d_name=&quot;.&quot;} {d_ino=4026531879, d_off=2, d_reclen=24, d_name=&quot;..&quot;}}, 4096) = 48</div>
<div class="line">[/sourcecode]</div>
</div>
<p>As you can see in the above trace, it returns '.' and '..', which means there are nothing in /proc/bus/usb. So what we do understand is 'lsusb' refers /dev/bus/usb and /proc/bus/usb for its outputs.. If it was not able to find anything, strace would have given us an error which obviously would have made life much easier.</p>
<p>And that's how '/sbin/lsusb' failed silently.. Isn't strace a nice tool ??</p>
<p>Okay, those who want to know why is this so... 'lsusb' needs either /mnt/sysimage/proc/bus/usb or /mnt/sysimage/dev/bus/usb display contents to work properly. Anaconda is not mounting /mnt/sysimage/proc/bus/usb with the 'usbfs' file system in the limited installation environment and hence 'lsusb' fails...</p>
<p>And we have a fix for that which goes into yuminstall.py in the anaconda source :</p>
<div class="line-block">
<div class="line">[sourcecode language=&quot;python&quot; gutter=&quot;false&quot;]</div>
<div class="line">try:</div>
<div class="line">&nbsp;&nbsp;&nbsp; isys.mount(&quot;/proc/bus/usb&quot;, anaconda.rootPath + &quot;/proc/bus/usb&quot;, &quot;usbfs&quot;)</div>
<div class="line">except Exception, e:</div>
<div class="line">&nbsp;&nbsp;&nbsp; log.error(&quot;error mounting usbfs: %s&quot; %(e,))</div>
<div class="line">[/sourcecode]</div>
</div>
<p>This piece of python code, tries mounting /proc/bus/usb on /mnt/sysimage/proc/bus/usb as 'usbfs. If its not possible, the code excepts an Exception error and reports &quot;error mounting 'usbfs'.</p>
                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>