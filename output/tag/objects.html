<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>arvimal.blog - objects</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">arvimal.blog </a></h1>
                <nav><ul>
                    <li><a href="/category/ceph.html">Ceph</a></li>
                    <li><a href="/category/ceph-programming-python.html">Ceph, Programming, Python</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming.html">Data Structures and Algorithms, Programming</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming-python.html">Data Structures and Algorithms, Programming, Python</a></li>
                    <li><a href="/category/linux-programming.html">Linux, Programming</a></li>
                    <li><a href="/category/misc.html">Misc</a></li>
                    <li><a href="/category/programming.html">Programming</a></li>
                    <li><a href="/category/programming-python.html">Programming, Python</a></li>
                    <li><a href="/category/techno.html">Techno</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/objects-remain-in-a-ceph-pool-used-for-rbd-even-if-the-files-are-deleted-from-the-mount-point.html">Ceph Rados Block Device (RBD) and TRIM</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-10-07T14:36:00+02:00">
                Published: Wed 07 October 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/arvimal.html">arvimal</a>
        </address>
<p>In <a href="/category/ceph.html">Ceph</a>.</p>
<p>tags: <a href="/tag/ceph.html">ceph</a> <a href="/tag/discard.html">discard</a> <a href="/tag/fstrim.html">fstrim</a> <a href="/tag/objects.html">objects</a> <a href="/tag/rados.html">rados</a> <a href="/tag/rados-block-device.html">rados block device</a> <a href="/tag/rbd.html">rbd</a> <a href="/tag/trim.html">trim</a> </p>
</footer><!-- /.post-info --><p>I recently came across a scenario where the objects in a RADOS pool used for an RBD block device doesn’t get removed, even if the files created through the mount point were removed.</p>
<p>I had an RBD image from an RHCS1.3 cluster mapped to a RHEL7.1 client machine, with an XFS filesystem created on it, and mounted locally. Created a 5GB file, and I could see the objects being created in the rbd pool in the ceph cluster.</p>
<p>1.RBD block device information</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line"># rbd info rbd_img</div>
<div class="line">rbd image 'rbd_img':</div>
<div class="line">size 10240 MB in 2560 objects</div>
<div class="line">order 22 (4096 kB objects)</div>
<div class="line">block_name_prefix: rb.0.1fcbe.2ae8944a</div>
<div class="line">format: 1</div>
<div class="line">[/code]</div>
</div>
<p>An XFS file system was created on this block device, and mounted at <strong>/test.</strong></p>
<p>2.Write a file onto the RBD mapped mount point. Used&nbsp;‘<strong>dd</strong>’ to write a 5GB file.</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line"># dd if=/dev/zero of=/mnt/rbd_image.img bs=1G count=5</div>
<div class="line">5+0 records in</div>
<div class="line">5+0 records out</div>
<div class="line">5368709120 bytes (5.4 GB) copied, 8.28731 s, 648 MB/s</div>
<div class="line">[/code]</div>
</div>
<p>3.Check the objects in the backend RBD pool</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line"># rados -p rbd ls | wc -l</div>
<div class="line">&amp;lt; Total number of objects in the 'rbd' pool&amp;gt;</div>
<div class="line">[/code]</div>
</div>
<p>4.Delete the file from the mount point.</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line"># rm /test/rbd_image.img -f</div>
<div class="line"># ls /test/</div>
<div class="line">--NO FILES LISTED--</div>
<div class="line">[/code]</div>
</div>
<p>5.List the objects in the RBD pool</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line"># rados -p rbd ls | wc -l</div>
<div class="line">&lt; Total number of objects in the 'rbd' pool &gt;</div>
<div class="line">[/code]</div>
</div>
<p>The number of objects doesn’t go down as we expect, after the file deletion. It remains the same, wrt to step 3.</p>
<p>Why does this happen? This is due to the fact that traditional file systems do not delete the underlying data blocks even if the files are deleted.</p>
<p>The process of writing a file onto a file system involves several steps like finding free blocks and allocating them for the new file, creating an entry in the directory entry structure of the parent folder, setting the name and inode number in the directory entry structure, setting pointers from the inode to the data blocks allocated for the file etc..</p>
<p>When data is written to the file, the data blocks are used to store the data. Additional information such as the file size, access times etc.. are updated in the inode after the writes.</p>
<p>Deleting a file involves removing the pointers from the inode to the corresponding data blocks, and also clearing the name&lt;-&gt;inode mapping from the directory entry structure of the parent folder. But, the underlying data blocks are not cleared off, since that is a high I/O intensive operation. So, the data remains on the disk, even if the file is not present. A new write will make the allocator take these blocks for the new data, since they are marked as not-in-use.</p>
<p>This applies for the files created on an RBD device as well. The files created on top of the RBD-mapped mount point will ultimately be mapped to objects in the RADOS cluster. When the file is deleted from the mount point, since the entry is removed, it doesn’t show up in the mount point.</p>
<p>But, since the file system doesn’t clear off the underlying block device, the objects remain in the <strong>RADOS</strong> pool. These would be normally over-written when a new file is created via the mount point.</p>
<p>But this has a catch though. Since the pool contains the objects even if the files are deleted, it consumes space in the rados pool (even if they'll be overwritten). An administrator won't be able to get a clear understanding on the space usage, if the pool is used heavily, and multiple writes are coming in.</p>
<p>In order to clear up the underlying blocks, or actually remove them, we can rely on the <strong>TRIM</strong> support most modern disks offer. Read more about <strong>TRIM</strong>&nbsp;at&nbsp;<a class="reference external" href="https://en.wikipedia.org/wiki/Trim_%28computing%29">Wikipedia</a>.</p>
<p><strong>TRIM</strong> is a set of commands supported by HDD/SSDs which allow the operating systems to let the disk know about the locations which are not currently being used. Upon receiving a confirmation from the file system layer, the disk can go ahead and mark the blocks as not used.</p>
<p>For the TRIM commands to work, the disks and the file system has to have the support. All the modern file systems have built-in support for <strong>TRIM</strong>. Mount the file system with the '<strong>discard</strong>' option, and you're good to go.</p>
<div class="line-block">
<div class="line">[code language=&quot;bash&quot;]</div>
<div class="line"># mount -o discard /dev/rbd{X}{Y} /{mount-point}</div>
<div class="line">[/code]</div>
</div>
                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>