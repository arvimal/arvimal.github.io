<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>FSCache and the on-disk structure of the cached data</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">arvimal.blog </a></h1>
                <nav><ul>
                    <li><a href="/category/ceph.html">Ceph</a></li>
                    <li><a href="/category/ceph-programming-python.html">Ceph, Programming, Python</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming.html">Data Structures and Algorithms, Programming</a></li>
                    <li><a href="/category/data-structures-and-algorithms-programming-python.html">Data Structures and Algorithms, Programming, Python</a></li>
                    <li><a href="/category/linux-programming.html">Linux, Programming</a></li>
                    <li><a href="/category/misc.html">Misc</a></li>
                    <li><a href="/category/programming.html">Programming</a></li>
                    <li><a href="/category/programming-python.html">Programming, Python</a></li>
                    <li class="active"><a href="/category/techno.html">Techno</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/structure-of-the-cached-content-in-fscache.html" rel="bookmark"
           title="Permalink to FSCache and the on-disk structure of the cached data">FSCache and the on-disk structure of the cached data</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-11-12T05:31:00+01:00">
                Published: Wed 12 November 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/arvimal.html">arvimal</a>
        </address>
<p>In <a href="/category/techno.html">Techno</a>.</p>
<p>tags: <a href="/tag/cachefilesd.html">cachefilesd</a> <a href="/tag/cachefs.html">cachefs</a> <a href="/tag/fscache.html">FSCache</a> </p>
</footer><!-- /.post-info -->      <p>The 'cachefilesd' kernel module will create two directories at the location specified in /etc/cachefilesd.conf. By default it's /var/cache/fscache/.</p>
<blockquote>
<div class="line-block">
<div class="line"><strong>[root&#64;montypython ~]# lsmod |grep -i cache</strong></div>
<div class="line">cachefiles&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 40871&nbsp; 1</div>
<div class="line">fscache&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 62354&nbsp; 3 nfs,cachefiles,nfsv4</div>
</div>
</blockquote>
<p>Those are <em>/var/cache/fscache/cache</em> and <em>/var/cache/fscache/graveyard</em>.</p>
<p>The cache structure is maintained inside '/var/cache/fscache/cache/', while anything that is retired or culled is moved to 'graveyard'. The 'cachefilesd' daemon monitors 'graveyard' using 'dnotify' and will delete anything that is in there.</p>
<p>We'll try an example. Consider an NFS share mounted with fscache support. The share contains the following files, with some random text.</p>
<blockquote>
<div class="line-block">
<div class="line"><strong># ls /vol1</strong></div>
<div class="line">files1.txt&nbsp; files2.txt&nbsp; files3.txt&nbsp; files4.txt</div>
</div>
</blockquote>
<ol class="loweralpha">
<li><p class="first">Configure 'cachefiles' by editing '/etc/cachefilesd.conf', and start the 'cachefilesd' daemon.</p>
<p><strong># systemctl start cachefilesd</strong></p>
</li>
<li><p class="first">Mount the NFS share on the client with the 'fsc' mount option, to enable 'fscache' support.</p>
<p><strong># sudo mount localhost:/vol1 /vol1-backup/ -o fsc</strong></p>
</li>
</ol>
<ol class="loweralpha simple" start="4">
<li>Access the data from the mount point, and fscache will create the backed caching index at the location specified in <em>/etc/cachefilesd.conf</em>. By default, its <em>/var/cache/fscache/</em></li>
<li>Once the files are accessed on the client side, fscache builds an index as following:</li>
</ol>
<p>NOTE: The index structure is <strong>dependent</strong>&nbsp;on the netfs (NFS in our case). The netfs driver can structure the cache index as it seems fit.</p>
<p>Explanation of the caching structure:</p>
<blockquote>
<div class="line-block">
<div class="line"># tree /var/cache/fscache/</div>
<div class="line">/var/cache/fscache/cache/</div>
<div class="line">└── &#64;4a</div>
<div class="line">└── I03nfs</div>
<div class="line">├── &#64;22</div>
<div class="line">│&nbsp;&nbsp; └── Jo00000008400000000000000000000000400</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── &#64;59</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── J110000000000000000w080000000000000000000000</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── &#64;53</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── EE0g00sgwB-90600000000ww000000000000000</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── &#64;5e</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── EE0g00sgwB-90600000000ww000000000000000</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── &#64;61</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── EE0g00sgwB-90600000000ww000000000000000</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── &#64;62</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── EE0g00sgwB-90600000000ww000000000000000</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── &#64;70</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── EE0g00sgwB-90600000000ww000000000000000</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── &#64;7c</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── EE0g00sgwB-90600000000ww000000000000000</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── &#64;e8</div>
<div class="line">│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── EE0g00sgwB-90600000000ww0000000000000000</div>
<div class="line">└── &#64;42</div>
<div class="line">└── Jc000000000000EggDj00</div>
<div class="line">└── &#64;0a</div>
</div>
</blockquote>
<ol class="loweralpha simple">
<li>The '<strong>cache</strong>' directory under <em>/var/cache/fscache/</em> is a special index and can be seen as the root of the entire cache index structure.</li>
<li>Data objects (actual cached files) are represented as files if they have no children, or folders if they have. If represented as a directory, data objects will have a file inside named 'data' which holds the data.</li>
<li>The '<strong>cachefiles</strong>' kernel module represents :</li>
</ol>
<ol class="lowerroman simple">
<li>&nbsp; '<strong>index</strong>' objects as '<strong>directories</strong>', starting with either '<strong>I</strong>' or '<strong>J</strong>'.</li>
<li>&nbsp;Data objects are represented with filenames, beginning with '<strong>D</strong>' or '<strong>E</strong>'.</li>
<li>Special objects are similar to data objects, and start with '<strong>S</strong>' or '<strong>T</strong>'.</li>
</ol>
<p>In general, any object would be represented as a folder, if that object has children.</p>
<ol class="loweralpha simple" start="7">
<li>In the directory hierarchy, immediately between the parent object and its child object, are directories named with *<strong>hash values</strong>* of the immediate child object keys, starting with an '<strong>&#64;</strong>'.</li>
</ol>
<p>The child objects are placed inside this directory.These child objects would be folders, if it has child objects, or files if its the cached data itself. This can go on till the end of the path and reaches the file where the cached data is.</p>
<p>Representation of the object indexes (For NFS, in this case)</p>
<blockquote>
<div class="line-block">
<div class="line">INDEX&nbsp;&nbsp;&nbsp;&nbsp; INDEX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INDEX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DATA FILES</div>
<div class="line">========= ========== ================================= ================</div>
<div class="line"><a class="reference external" href="mailto:cache/&#64;4a/I03nfs">cache/&#64;4a/I03nfs</a><a class="reference external" href="mailto:/&#64;30/Ji000000000000000--fHg8hi8400">/&#64;30/Ji000000000000000--fHg8hi8400</a></div>
<div class="line"><a class="reference external" href="mailto:cache/&#64;4a/I03nfs">cache/&#64;4a/I03nfs</a><a class="reference external" href="mailto:/&#64;30/Ji000000000000000--fHg8hi8400">/&#64;30/Ji000000000000000--fHg8hi8400</a><a class="reference external" href="mailto:/&#64;75/Es0g000w...DB1ry">/&#64;75/Es0g000w...DB1ry</a></div>
<div class="line"><a class="reference external" href="mailto:cache/&#64;4a/I03nfs">cache/&#64;4a/I03nfs</a><a class="reference external" href="mailto:/&#64;30/Ji000000000000000--fHg8hi8400">/&#64;30/Ji000000000000000--fHg8hi8400</a><a class="reference external" href="mailto:/&#64;75/Es0g000w...N22ry">/&#64;75/Es0g000w...N22ry</a></div>
<div class="line"><a class="reference external" href="mailto:cache/&#64;4a/I03nfs">cache/&#64;4a/I03nfs</a><a class="reference external" href="mailto:/&#64;30/Ji000000000000000--fHg8hi8400">/&#64;30/Ji000000000000000--fHg8hi8400</a><a class="reference external" href="mailto:/&#64;75/Es0g000w...FP1ry">/&#64;75/Es0g000w...FP1ry</a></div>
</div>
</blockquote>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>